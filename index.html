<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Elite Terminal v6.5 - Kararlı Sürüm</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root { --bg: #030508; --card-bg: rgba(16, 20, 29, 0.95); --accent: #00ff9d; --red: #ff3b5c; --text: #ffffff; --border: rgba(255, 255, 255, 0.1); }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; font-size: 14px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .section-title { font-size: 0.65rem; font-weight: 800; color: #94a3b8; margin: 15px 0 8px 5px; text-transform: uppercase; letter-spacing: 1px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    .card { background: var(--card-bg); padding: 12px; border-radius: 14px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative; border-left: 3px solid #334155; }
    .card:active { transform: scale(0.97); }
    .card span { color: #94a3b8; font-size: 0.55rem; font-weight: 700; display: block; margin-bottom: 4px; }
    .card .value { font-size: 0.82rem; font-weight: 800; display: block; white-space: nowrap; }
    .card .perc { font-size: 0.65rem; font-weight: 700; margin-top: 4px; }
    .up { color: var(--accent); } .down { color: var(--red); }
    .up-card { border-left-color: var(--accent); } .down-card { border-left-color: var(--red); }
    
    #detailPanel { display: none; background: #111827; border-radius: 18px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; }
    
    .content-block { background: var(--card-bg); border-radius: 18px; border: 1px solid var(--border); padding: 15px; margin-top: 15px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .chart-select { background: #111827; color: var(--accent); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 0.7rem; outline: none; }
    .m-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .m-item { background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 8px; display: flex; justify-content: space-between; border: 1px solid var(--border); }
  </style>
</head>
<body>

<div class="container">
  <div id="detailPanel">
    <div style="color:var(--red); float:right; cursor:pointer; font-weight:800; padding:5px;" onclick="closeDetails()">KAPAT ✕</div>
    <div id="detailTitle" style="font-size: 0.7rem; font-weight: 800; color: var(--accent); margin-bottom: 10px;">DETAYLAR</div>
    <div id="detailList"></div>
  </div>

  <div class="section-title">Portföy Özeti</div>
  <div class="grid" id="topCards"></div>

  <div class="section-title">Kısa Vade Performans</div>
  <div class="grid" id="shortKZ"></div>

  <div class="section-title">Uzun Vade Performans</div>
  <div class="grid" id="longKZ"></div>

  <div class="content-block">
    <div class="chart-header">
      <span style="font-size: 0.7rem; font-weight: 800; color: var(--accent);">VARLIK DAĞILIMI</span>
      <select class="chart-select" id="chartType" onchange="renderUI()">
        <option value="doughnut">Halka (Doughnut)</option>
        <option value="bar">Çubuk (Bar)</option>
        <option value="pie">Pasta (Pie)</option>
      </select>
    </div>
    <div style="height: 280px;"><canvas id="allocationChart"></canvas></div>
  </div>

  <div class="section-title">Piyasa Göstergeleri (Macro)</div>
  <div class="content-block"><div class="m-grid" id="marketGrid"></div></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
  Chart.register(ChartDataLabels);
  
  const portfoyUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
  const macroUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=1018386005&single=true&output=csv";
  
  let pData = [], mData = [], myChart = null;

  // Rakamlardaki nokta/virgül sorununu kökten çözen fonksiyon
  function clean(v) {
    if (!v || v === "" || v.toString().includes('#N/A') || v.toString().includes('Güncelle')) return 0;
    let s = v.toString().trim();
    // Türkiye formatı: 12.007.400,50 -> Önce noktaları sil, sonra virgülü noktaya çevir
    if (s.includes('.') && s.includes(',')) {
      s = s.replace(/\./g, '').replace(',', '.');
    } else if (s.includes(',')) {
      s = s.replace(',', '.');
    } else if (s.includes('.')) {
      // Sadece nokta varsa ve virgülden sonra 3 basamak varsa bu binlik ayracıdır
      let parts = s.split('.');
      if (parts[parts.length - 1].length === 3) s = s.replace(/\./g, '');
    }
    let num = parseFloat(s.replace(/[^0-9.-]+/g, ''));
    return isNaN(num) ? 0 : num;
  }

  async function fetchData() {
    const cb = "&cache=" + Date.now();
    try {
      const [resP, resM] = await Promise.all([
        new Promise(res => Papa.parse(portfoyUrl + cb, { download: true, complete: res })),
        new Promise(res => Papa.parse(macroUrl + cb, { download: true, complete: res }))
      ]);
      
      pData = resP.data.slice(1).map(r => ({
        ad: r[0], tur: r[1], yatirim: clean(r[6]), tutar: clean(r[8]), 
        g: clean(r[9]), h: clean(r[10]), a: clean(r[11]),
        k3: clean(r[12]), k6: clean(r[13]), k1y: clean(r[14]), t: clean(r[15])
      })).filter(d => d.tutar > 0 || d.yatirim > 0);

      mData = resM.data.slice(1).filter(r => r[0]);
      renderUI();
    } catch (e) { console.error("Veri hatası:", e); }
  }

  function renderUI() {
    const t = { y:0, p:0, t:0, g:0, h:0, a:0, k3:0, k6:0, k1y:0 };
    const groups = {};

    pData.forEach(d => {
      // "Toplam" satırı varsa toplama dahil etme (mükerrerliği önler)
      if (d.ad && d.ad.toLowerCase().includes("toplam")) return;
      
      t.y += d.yatirim; t.p += d.tutar; t.t += d.t;
      t.g += d.g; t.h += d.h; t.a += d.a;
      t.k3 += d.k3; t.k6 += d.k6; t.k1y += d.k1y;
      if(d.tur) groups[d.tur] = (groups[d.tur] || 0) + d.tutar;
    });

    const format = (v) => v.toLocaleString('tr-TR', { maximumFractionDigits: 0 });
    const getP = (v) => ((v / t.p) * 100).toFixed(2);

    const card = (label, val, key) => {
      const isKZ = !['y', 'p'].includes(key);
      const colorClass = isKZ ? (val >= 0 ? 'up' : 'down') : '';
      const borderClass = isKZ ? (val >= 0 ? 'up-card' : 'down-card') : '';
      return `<div class="card ${borderClass}" onclick="showDetails('${label}', '${key}')">
                <span>${label}</span>
                <div class="value ${isKZ ? colorClass : ''}">${format(val)} ₺</div>
                ${isKZ ? `<div class="perc ${colorClass}">${val>=0?'▲':'▼'} %${Math.abs(getP(val))}</div>` : ''}
              </div>`;
    };

    // A) Üst Kartlar
    document.getElementById("topCards").innerHTML = 
      `<div class="card"><span>Toplam Yatırım</span><div class="value">${format(t.y)} ₺</div></div>` +
      `<div class="card"><span>Güncel Portföy</span><div class="value">${format(t.p)} ₺</div></div>` +
      card('Toplam K/Z', t.t, 't');

    // B) Kısa Vade
    document.getElementById("shortKZ").innerHTML = card('Günlük K/Z', t.g, 'g') + card('Haftalık K/Z', t.h, 'h') + card('Aylık K/Z', t.a, 'a');
    
    // C) Uzun Vade
    document.getElementById("longKZ").innerHTML = card('3 Aylık K/Z', t.k3, 'k3') + card('6 Aylık K/Z', t.k6, 'k6') + card('1 Yıllık K/Z', t.k1y, 'k1y');

    // Macro Grid
    document.getElementById("marketGrid").innerHTML = mData.map(d => `
      <div class="m-item">
        <span style="font-size:0.55rem; font-weight:700; color:#94a3b8;">${d[0]}</span>
        <span class="up" style="font-weight:800; font-family:monospace;">${clean(d[1]).toLocaleString('tr-TR')}</span>
      </div>`).join('');

    // Grafiği Çiz
    updateChart(groups);
  }

  function updateChart(groups) {
    const ctx = document.getElementById('allocationChart').getContext('2d');
    const type = document.getElementById("chartType").value;
    if(myChart) myChart.destroy();
    
    myChart = new Chart(ctx, {
      type: type,
      data: {
        labels: Object.keys(groups),
        datasets: [{
          data: Object.values(groups),
          backgroundColor: ['#00ff9d', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } },
          datalabels: {
            color: '#fff',
            font: { weight: 'bold', size: 11 },
            formatter: (value, context) => {
              const sum = context.dataset.data.reduce((a, b) => a + b, 0);
              const perc = (value * 100 / sum).toFixed(1) + "%";
              return type === 'bar' ? value.toLocaleString('tr-TR') + " ₺" : perc;
            }
          }
        }
      }
    });
  }

  function showDetails(label, key) {
    const res = {};
    pData.forEach(d => { if(d[key] !== undefined) res[d.tur] = (res[d.tur] || 0) + d[key]; });
    let html = "";
    for (let tur in res) {
      html += `<div class="detail-row"><span>${tur}</span><span class="${res[tur]>=0?'up':'down'}">${res[tur].toLocaleString('tr-TR')} ₺</span></div>`;
    }
    document.getElementById("detailTitle").innerText = label + " DAĞILIMI";
    document.getElementById("detailList").innerHTML = html;
    document.getElementById("detailPanel").style.display = "block";
    window.scrollTo({top: 0, behavior: 'smooth'});
  }

  function closeDetails() { document.getElementById("detailPanel").style.display = "none"; }

  fetchData();
  setInterval(fetchData, 300000);
</script>
</body>
</html>
