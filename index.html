<script>
/* ================= CONFIG ================= */
const PORTFOY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
const DATA_CSV    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=2136415211&single=true&output=csv";
const MACRO_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=1018386005&single=true&output=csv";

/* ================= HELPERS ================= */
function num(v){
  if(!v) return 0;
  return Number(
    String(v)
      .replace(/\./g,"")
      .replace(",",".")
  ) || 0;
}

/* ================= CSV LOADER (BULLETPROOF) ================= */
async function loadCSV(url){
  try{
    const r = await fetch(url);
    const t = await r.text();

    const lines = t.replace(/\r/g,"").split("\n").filter(l=>l.trim());
    if(lines.length < 2){
      console.warn("CSV bo≈ü:", url);
      return [];
    }

    const delimiter = lines[0].includes(";") ? ";" : ",";
    const headers = lines[0].split(delimiter).map(h=>h.trim());

    const data = lines.slice(1).map(line=>{
      const cols = line.split(delimiter);
      let o = {};
      headers.forEach((h,i)=>o[h]=cols[i]?.trim()||"");
      return o;
    });

    return data;

  }catch(e){
    console.error("CSV okunamadƒ±:", url, e);
    return [];
  }
}

/* ================= MAIN ================= */
(async function init(){

  const portfoy = await loadCSV(PORTFOY_CSV);
  const data    = await loadCSV(DATA_CSV);
  const macro   = await loadCSV(MACRO_CSV);

  console.log("üì¶ PORTF√ñY:", portfoy);
  console.log("üìà DATA:", data);
  console.log("üåç MACRO:", macro);

  if(!portfoy.length){
    document.body.innerHTML = "<h2>‚ùå Portf√∂y verisi gelmedi</h2>";
    return;
  }

  /* ===== TOPLAM ===== */
  let toplam = 0;
  let maliyet = 0;

  portfoy.forEach(r=>{
    toplam  += num(r["G√ºncel Tutar"] || r["Deger"]);
    maliyet += num(r["Maliyet"]);
  });

  const kar = toplam - maliyet;

  /* ===== ENFLASYON ===== */
  let enflasyon = 0;
  const enfRow = macro.find(r=>String(r["KOD"]).includes("ENFLASYON"));
  if(enfRow) enflasyon = num(enfRow["DEGER"]);

  const nominalGetiri = maliyet ? (kar / maliyet) * 100 : 0;
  const reelGetiri = nominalGetiri - enflasyon;

  /* ===== EKRANA BAS ===== */
  document.body.innerHTML = `
    <h1>üìä Lite Portf√∂y Terminali</h1>

    <div style="display:flex;gap:20px;flex-wrap:wrap">
      <div><b>Toplam Portf√∂y</b><br>${toplam.toLocaleString()} ‚Ç∫</div>
      <div><b>K√¢r / Zarar</b><br>${kar.toLocaleString()} ‚Ç∫</div>
      <div><b>Reel Getiri</b><br>
        <span style="color:${reelGetiri>=0?'green':'red'}">
          %${reelGetiri.toFixed(2)}
        </span>
      </div>
    </div>

    <h3 style="margin-top:30px">üåç Makro G√∂stergeler</h3>
    <ul>
      ${macro.map(m=>`<li>${m.KOD} : ${m.DEGER}</li>`).join("")}
    </ul>
  `;

})();
</script>
