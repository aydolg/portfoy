<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>PortfÃ¶y Terminali Pro Max â€” FINAL V3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
:root{ --bg:#0b1220; --card:#111827; --line:#1f2937; --pos:#22c55e; --neg:#ef4444; --accent:#3b82f6; --text:#e5e7eb; --muted:rgba(229,231,235,.7); --warn:#f59e0b; }
*{ box-sizing: border-box; }
body{ margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow-x:hidden; }
h2{ margin:14px 16px 6px; font-size:12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
/* Ticker */
.ticker-wrap{ width:100%; overflow:hidden; background:#1a2234; border-bottom:2px solid var(--line); padding:12px 0; display:flex; position: sticky; top:0; z-index: 100; }
.ticker{ display:flex; white-space:nowrap; animation: ticker-move 40s linear infinite; }
.ticker-item{ display:flex; align-items:center; padding:0 25px; font-size:14px; font-weight:800; border-right:1px solid rgba(255,255,255,0.1); }
@keyframes ticker-move { 0%{ transform: translateX(0); } 100%{ transform: translateX(-50%); } }
.header-section{ position: sticky; top: 48px; z-index: 99; background: rgba(11, 18, 32, 0.95); backdrop-filter: blur(15px); border-bottom: 1px solid var(--line); padding: 10px; }
.grid-summary{ display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-bottom:12px; }
@media (max-width: 480px){ .grid-summary{ grid-template-columns: repeat(2, 1fr); } }
/* TYPES now bigger */
.grid-types{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; padding:0 10px 10px; }
.grid-types .card{ padding:14px 20px; min-width:110px; font-size:15px; font-weight:700; text-align:center; border-radius:12px; background:linear-gradient(145deg, var(--card), #1a2234); transition:0.2s; cursor:pointer; }
.grid-types .card.active{ background:rgba(59,130,246,0.25); border-color:var(--accent); box-shadow:0 0 12px rgba(59,130,246,0.3); }
@media (max-width:480px){.grid-types .card{min-width:90px; padding:12px 14px; font-size:13px;}}
/* Kart */
.card{ background: linear-gradient(145deg, var(--card), #161e2e); border-radius: 12px; padding: 10px; border: 1px solid var(--line); display: flex; flex-direction: column; transition: 0.2s ease; cursor:pointer;}
.card.active{ border-color: var(--accent); background: rgba(59,130,246,0.1); }
.alert-triggered { border: 1px solid var(--neg) !important; box-shadow: 0 0 12px rgba(239, 68, 68, 0.25); }
.alert-msg { font-size: 9px; color: var(--warn); font-weight: bold; margin-top: 4px; text-transform: uppercase; }
.big{ font-size:15px; font-weight:700; margin-top:2px; }
.small{ font-size:10.5px; opacity:0.85; text-transform: uppercase; display:block; margin-bottom:3px; }
.pos{ color: var(--pos); } .neg{ color: var(--neg); }
.detail-item{ background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction:column; gap:14px; cursor:pointer;}
.detail-item table th, .detail-item table td{ padding:6px 8px; border-bottom:1px solid var(--line); font-size:11px; text-align:center; }
.detail-item table th{ color:var(--muted); font-weight:600; text-transform:uppercase; }
#search{ flex: 1; padding: 8px 12px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; color: #fff; height: 38px;}
#loader{ position: fixed; inset:0; background:var(--bg); z-index:999; display:flex; justify-content:center; align-items:center; font-weight:bold; color:var(--accent); }
/* Modal */
.modal-backdrop{ position: fixed; inset:0; background: rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index: 1000; }
.modal-backdrop.show{ display:flex; }
.modal-card{ background: #0f172a; border: 1px solid var(--line); border-radius: 16px; width: min(700px, 95vw); max-height: 90vh; overflow-y: auto; }
/* Sparkline */
.sparkline-wrap{ background:#0b1329; border:1px solid var(--line); border-radius:10px; padding:8px; position: relative; }
.sparkline-title{ font-size:10px; opacity:.8; text-transform:uppercase; margin-bottom:6px; }
.sparkline-tooltip { position:absolute; background: rgba(0,0,0,.85); color:#fff; padding:6px 8px; border-radius:6px; font-size:11px; pointer-events:none; transform: translate(-50%, -120%); white-space:nowrap; z-index: 1001; border:1px solid var(--line); display:none; }
.sparkline-wrap canvas{ width:100% !important; height: 160px; display:block; }
.refresh-inline{ margin-left:auto; font-size:10px; opacity:.7; padding-right:6px; }
</style>
</head>
<body>
<div id="loader">YÃœKLENÄ°YOR...</div>
<div class="ticker-wrap"><div class="ticker" id="ticker-content"></div></div>
<div class="header-section">
  <div class="grid-summary" id="summary"></div>
  <h2>ðŸ’¼ VARLIK GRUPLARI</h2>
  <div class="grid-types" id="types"></div>
</div>
<div class="content-section">
  <h2>ðŸ“ˆ DÃ–NEMSEL PERFORMANS</h2>
  <div id="periods" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; padding:0 10px; margin-bottom:15px;"></div>
  <div class="controls" style="display:flex; gap:8px; padding:10px; flex-wrap:wrap;">
    <select id="sort-by" class="select" style="background:var(--card);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px;font-size:12px;height:38px;">
      <option value="kz">K/Z SÄ±rala</option>
      <option value="guncel">DeÄŸer SÄ±rala</option>
      <option value="ad">Ad SÄ±rala</option>
    </select>
    <select id="auto-refresh" class="select" style="background:var(--card);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px;font-size:12px;height:38px;">
      <option value="5" selected>5 dakika</option>
      <option value="1">1 dakika</option>
      <option value="15">15 dakika</option>
      <option value="0">KapalÄ±</option>
    </select>
    <input type="text" id="search" placeholder="ÃœrÃ¼n ara..." style="flex:1; padding:8px 12px; background:var(--card); border:1px solid var(--line); border-radius:8px; color:#fff; height:38px;" />
  </div>
  <div id="detail-list" style="padding: 0 10px;"></div>
</div>
<div id="modal" class="modal-backdrop">
  <div class="modal-card" id="modal-inner"></div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DeÄŸiÅŸkenler ve yardÄ±mcÄ± fonksiyonlar (deÄŸiÅŸmedi)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLPFVZn0j8Ygu914QDGRCGKsVy88gWjdk7DFi-jWiydmqYsdGUE4hEAb-R_IBzQmtFZwoMJFcN6rlD/pub?gid=1050165900&single=true&output=csv";
const HISTORY_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLPFVZn0j8Ygu914QDGRCGKsVy88gWjdk7DFi-jWiydmqYsdGUE4hEAb-R_IBzQmtFZwoMJFcN6rlD/pub?gid=1490096590&single=true&output=csv";
const ALERTS_KEY = "portfolio_alerts_v1";
let DATA = []; let ACTIVE_PILL = "ALL"; let REFRESH_INT = null; let PRICE_HISTORY = []; let HISTORY_BY_URUN = {};
const toNumber = (v) => { if (v===null||v===undefined) return 0; let s=v.toString().trim(); if(!s) return 0; s=s.replace(/[â‚º\s]/g,''); if(s.includes(',')&&s.includes('.')){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(',', '.'); } s=s.replace(/[^\d.\-]/g,''); const n=parseFloat(s); return Number.isFinite(n)?n:0; };
const formatTRY = v => Math.round(v).toLocaleString('tr-TR') + " â‚º";
const formatPrice = v => parseFloat(v).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " â‚º";
function parseDateTR(s){ if(!s) return null; if(s instanceof Date) return s; const a=s.toString().split('.'); if(a.length!==3) return null; const dd=+a[0], mm=+a[1], yy=+a[2]; if(!dd||!mm||!yy) return null; return new Date(yy, mm-1, dd); }
async function loadHistory(){ const res=await fetch(`${HISTORY_URL}&cb=${Date.now()}`); const text=await res.text(); const p=Papa.parse(text.trim(),{header:true}); PRICE_HISTORY=p.data.map(r=>({urun:r.urun||r['ÃœrÃ¼n']||r['Urun'], date:parseDateTR(r.tarih||r['Tarih']), price:toNumber(r.fiyat||r['Fiyat'])})).filter(x=>x.urun&&x.date&&(x.price||x.price===0)); HISTORY_BY_URUN={}; for(const row of PRICE_HISTORY){ (HISTORY_BY_URUN[row.urun]??=[]).push({date:row.date, price:row.price}); } Object.keys(HISTORY_BY_URUN).forEach(k=>HISTORY_BY_URUN[k].sort((a,b)=>a.date-b.date)); }
function getClosestBackwardPrice(urun, targetDate) { const h = HISTORY_BY_URUN[urun]; if (!h || h.length === 0) return null; for (let i = h.length - 1; i >= 0; i--) { if (h[i].date <= targetDate) return h[i].price; } return null; }
function getChangeTRY(urun, adet, daysBack) { const h = HISTORY_BY_URUN[urun]; if (!h || h.length === 0) return 0; const last = h[h.length - 1].price; const lastDate = h[h.length - 1].date; const target = new Date(lastDate); target.setDate(target.getDate() - daysBack); const past = getClosestBackwardPrice(urun, target); if (past === null) return 0; return adet * (last - past); }
function getAlertMsg(item){ const alerts=JSON.parse(localStorage.getItem(ALERTS_KEY))||{}; const a=alerts[item.urun]; if(!a) return null; const kz=item.guncelDeger-item.toplamYatirim; const prev=item.guncelDeger-item.gunluk; const dPct=(prev>0)?(item.gunluk/prev)*100:0; let m=[]; if(a.guncel&&item.guncelDeger>=a.guncel) m.push(`DeÄŸer â‰¥ ${formatTRY(a.guncel)}`); if(a.kz&&kz>=a.kz) m.push(`KÃ¢r â‰¥ ${formatTRY(a.kz)}`); if(a.gp&&dPct>=a.gp) m.push(`GÃ¼nlÃ¼k â‰¥ %${a.gp}`); return m.length>0?m.join(" | "):null; }
function updateLastRefresh(){ const now=new Date(); const txt=now.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}); const el=document.getElementById("last-refresh"); if(el) el.innerText="Son gÃ¼ncelleme: "+txt; }
function setAutoRefresh(mins){ clearInterval(REFRESH_INT); if(mins>0){ REFRESH_INT=setInterval(()=>{ init(); }, mins*60*1000); } }
function getClosestPrevForTicker(urun) { const h = HISTORY_BY_URUN[urun]; if (!h || h.length < 2) return null; const last = h[h.length - 1].price; for (let i = h.length - 2; i >= 0; i--) { const prev = h[i].price; if (prev !== last) return { last, prev }; } return null; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANA YÃœKLEME ve RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){ 
  try{
    const res=await fetch(`${CSV_URL}&cb=${Date.now()}`); 
    const text=await res.text(); 
    const p=Papa.parse(text.trim(),{header:true}); 
    DATA=p.data.map(r=>({
      ...r, 
      urun:(r.urun||r['ÃœrÃ¼n']||r['Urun']), 
      tur:(r.tur||r['TÃ¼r']||r['tur']), 
      adet:toNumber(r.adet||r.miktar||r['Miktar']||0), 
      fiyat:toNumber(r.fiyat||r.sonFiyat||r['Son Fiyat']||0), 
      toplamYatirim:toNumber(r.toplamYatirim), 
      guncelDeger:toNumber(r.guncelDeger), 
      gunluk:toNumber(r.gunluk), 
      haftalik:toNumber(r.haftalik), 
      aylik:toNumber(r.aylik), 
      ucAylik:toNumber(r.ucAylik), 
      altiAylik:toNumber(r.altiAylik), 
      birYillik:toNumber(r.birYillik)
    })).filter(i=>i.urun&&i.toplamYatirim>0); 
    
    await loadHistory(); 
    
    for(const item of DATA){
      const hist=HISTORY_BY_URUN[item.urun];
      if(hist&&hist.length){
        const lastPrice=hist[hist.length-1].price;
        if(!item.fiyat||item.fiyat<=0) item.fiyat=lastPrice;
        if(!item.guncelDeger||item.guncelDeger<=0) item.guncelDeger=item.adet*lastPrice;
        item.gunluk=getChangeTRY(item.urun,item.adet,1);
        item.haftalik=getChangeTRY(item.urun,item.adet,7);
        item.aylik=getChangeTRY(item.urun,item.adet,30);
        item.ucAylik=getChangeTRY(item.urun,item.adet,90);
        item.altiAylik=getChangeTRY(item.urun,item.adet,180);
        item.birYillik=getChangeTRY(item.urun,item.adet,365);
      }
    }

    document.getElementById("loader").style.display="none"; 
    renderAll(); 
    updateLastRefresh(); 
  }catch(e){ console.error(e); }
}

function renderAll(){ 
  let triggeredCount=0; 
  DATA.forEach(i=>{ if(getAlertMsg(i)) triggeredCount++; });

  const turlar=[...new Set(DATA.map(i=>i.tur))].filter(Boolean); 
  document.getElementById("types").innerHTML = `
    <div class="card ${ACTIVE_PILL==='ALL'?'active':''}" onclick="setActivePill('ALL')"><div>GENEL</div></div>
    ${turlar.map(t=>`<div class="card ${ACTIVE_PILL===t?'active':''}" onclick="setActivePill('${t}')"><div>${t}</div></div>`).join("")}
    <div class="card ${ACTIVE_PILL==='ALERTS'?'active':''}" onclick="setActivePill('ALERTS')"><div>UYARILAR (${triggeredCount})</div></div>
    <div id="last-refresh" class="refresh-inline">Son gÃ¼ncelleme: -</div>`;

  let filtered=DATA; 
  if(ACTIVE_PILL==="ALERTS") filtered=DATA.filter(i=>getAlertMsg(i)); 
  else if(ACTIVE_PILL!=="ALL") filtered=DATA.filter(i=>i.tur===ACTIVE_PILL);

  const fM=filtered.reduce((a,b)=>a+b.toplamYatirim,0); 
  const fG=filtered.reduce((a,b)=>a+b.guncelDeger,0);
  const kzTotal = fG - fM;
  const kzPct = fM > 0 ? ((kzTotal / fM) * 100).toFixed(1) : '0.0';
  const totalG = DATA.reduce((a,b)=>a+b.guncelDeger,0);

  document.getElementById("summary").innerHTML = `
    <div class="card"><div class="small">Toplam Maliyet</div><div class="big">${formatTRY(fM)}</div></div>
    <div class="card"><div class="small">GÃ¼ncel DeÄŸer</div><div class="big">${formatTRY(fG)}</div></div>
    <div class="card ${kzTotal>=0?'pos':'neg'}"><div class="small">K/Z (â‚º)</div><div class="big">${formatTRY(kzTotal)}</div></div>
    <div class="card ${kzTotal>=0?'pos':'neg'}"><div class="small">K/Z (%)</div><div class="big">${kzPct}%</div></div>`;

  const pers=[["GÃ¼nlÃ¼k","gunluk"],["HaftalÄ±k","haftalik"],["AylÄ±k","aylik"],["3 AylÄ±k","ucAylik"],["6 AylÄ±k","altiAylik"],["1 YÄ±llÄ±k","birYillik"]];
  document.getElementById("periods").innerHTML = pers.map(([l,k])=>{ 
    const v=filtered.reduce((a,b)=>a+b[k],0); 
    return `<div class="card ${v>=0?'pos':'neg'}"><div class="small">${l}</div><div class="big">${formatTRY(v)}</div></div>`; 
  }).join("");

  // â”€â”€â”€ Yeni ÃœrÃ¼n KartÄ± YapÄ±sÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sort=document.getElementById("sort-by").value; 
  let listData=[...filtered];
  listData.sort((a,b)=>{ 
    if(sort==='kz') return (b.guncelDeger-b.toplamYatirim)-(a.guncelDeger-a.toplamYatirim); 
    if(sort==='guncel') return b.guncelDeger-a.guncelDeger; 
    return a.urun.localeCompare(b.urun); 
  });

  document.getElementById("detail-list").innerHTML = listData.map(item=>{ 
    const kz = item.guncelDeger - item.toplamYatirim;
    const pct = item.toplamYatirim > 0 ? (kz / item.toplamYatirim * 100).toFixed(1) : '0.0';
    const msg = getAlertMsg(item);
    const ortFiyat = item.adet > 0 ? (item.toplamYatirim / item.adet) : item.fiyat;
    const portfÃ¶yPay = totalG > 0 ? ((item.guncelDeger / totalG) * 100).toFixed(1) : '0.0';
    const birimKZ = item.adet > 0 ? (kz / item.adet) : 0;

    return `
    <div class="detail-item ${msg?'alert-triggered':''}" onclick="openDetail('${item.urun.replace(/'/g, "\\'")}')">
      <div style="display:flex; flex-direction:column; gap:12px; width:100%;">

        <!-- 1. satÄ±r -->
        <div style="display:flex; justify-content:space-between; font-size:11.5px; color:var(--muted);">
          <div><strong>${item.tur || 'â€”'}</strong></div>
          <div>PortfÃ¶y: %${portfÃ¶yPay}</div>
          <div>Elde: â€” gÃ¼n</div>
        </div>

        <!-- 2. satÄ±r -->
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; font-size:13px;">
          <div><div class="small">Adet</div><div class="big">${item.adet.toLocaleString('tr-TR')}</div></div>
          <div><div class="small">Ort. Fiyat</div><div class="big">${formatPrice(ortFiyat)}</div></div>
          <div><div class="small">GÃ¼ncel Fiyat</div><div class="big">${formatPrice(item.fiyat)}</div></div>
          <div class="${birimKZ>=0?'pos':'neg'}"><div class="small">Birim K/Z</div><div class="big">${formatPrice(birimKZ)}</div></div>
        </div>

        <!-- DeÄŸer + Toplam K/Z -->
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
          <div>DeÄŸer: ${formatTRY(item.guncelDeger)}</div>
          <div class="${kz>=0?'pos':'neg'}">${formatTRY(kz)} (${pct}%)</div>
        </div>

        <!-- 3. satÄ±r - DÃ¶nem tablosu -->
        <div style="overflow-x:auto;">
          <table style="width:100%; min-width:480px;">
            <thead>
              <tr><th>DÃ¶nem</th><th>DeÄŸiÅŸim â‚º</th><th>Son DeÄŸer â‚º</th><th>K/Z â‚º</th><th>Getiri %</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>GÃ¼nlÃ¼k</td>
                <td class="${item.gunluk>=0?'pos':'neg'}">${formatTRY(item.gunluk)}</td>
                <td>${formatTRY(item.guncelDeger)}</td>
                <td class="${kz>=0?'pos':'neg'}">${formatTRY(kz)}</td>
                <td class="${pct>=0?'pos':'neg'}">${pct}%</td>
              </tr>
              <tr>
                <td>HaftalÄ±k</td>
                <td class="${item.haftalik>=0?'pos':'neg'}">${formatTRY(item.haftalik)}</td>
                <td>${formatTRY(item.guncelDeger)}</td>
                <td class="${kz>=0?'pos':'neg'}">${formatTRY(kz)}</td>
                <td class="${pct>=0?'pos':'neg'}">${pct}%</td>
              </tr>
              <tr>
                <td>AylÄ±k</td>
                <td class="${item.aylik>=0?'pos':'neg'}">${formatTRY(item.aylik)}</td>
                <td>${formatTRY(item.guncelDeger)}</td>
                <td class="${kz>=0?'pos':'neg'}">${formatTRY(kz)}</td>
                <td class="${pct>=0?'pos':'neg'}">${pct}%</td>
              </tr>
            </tbody>
          </table>
        </div>

        ${msg?`<div class="alert-msg" style="margin-top:8px;">${msg}</div>`:''}
      </div>
    </div>`;
  }).join("");

  // Ticker (deÄŸiÅŸmedi)
  const tickerItems = DATA.map(r=>{ 
    const pair=getClosestPrevForTicker(r.urun); 
    let pct=0; 
    if(pair && pair.prev>0){ pct=((pair.last - pair.prev)/pair.prev)*100; } 
    const color = pct>=0 ? 'var(--pos)' : 'var(--neg)'; 
    return `<div class="ticker-item" style="color:${color}">${r.urun} %${pct.toFixed(1)}</div>`; 
  }).join("");
  document.getElementById("ticker-content").innerHTML = tickerItems + tickerItems;

  updateLastRefresh();
}

function setActivePill(p){ ACTIVE_PILL=p; renderAll(); }

// â”€â”€â”€ Modal ve Sparkline (ÅŸimdilik deÄŸiÅŸmedi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSparkline(canvas, values, dates, color='#3b82f6'){
  canvas.width = Math.max(320, canvas.clientWidth*2);
  canvas.height = 220;
  const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H); if(!values||!values.length) return; 
  const min=Math.min(...values), max=Math.max(...values); const pad=8; 
  const nx=i=> pad + (i*(W-2*pad))/Math.max(1,(values.length-1)); 
  const ny=v=> (max===min? H/2 : (H - pad - ((v-min)*(H-2*pad)/(max-min))));
  ctx.lineWidth=2; ctx.strokeStyle=color; ctx.beginPath(); ctx.moveTo(nx(0), ny(values[0])); 
  for(let i=1;i<values.length;i++) ctx.lineTo(nx(i), ny(values[i])); 
  ctx.stroke(); ctx.lineTo(nx(values.length-1), H-pad); ctx.lineTo(nx(0), H-pad); ctx.closePath(); 
  ctx.fillStyle='rgba(59,130,246,0.15)'; ctx.fill();
  let tooltip=canvas.parentElement.querySelector('.sparkline-tooltip'); 
  if(!tooltip){ tooltip=document.createElement('div'); tooltip.className='sparkline-tooltip'; canvas.parentElement.appendChild(tooltip); }
  canvas.onmousemove=(ev)=>{ 
    const rect=canvas.getBoundingClientRect(); const x=ev.clientX-rect.left; 
    const idx=Math.round((x - pad) / ((canvas.clientWidth - 2*(pad/2)) / Math.max(1,(values.length-1)))); 
    const i=Math.max(0, Math.min(values.length-1, idx)); 
    tooltip.style.left = `${x}px`; tooltip.style.top = `${ny(values[i])*(canvas.clientHeight/canvas.height)}px`; 
    tooltip.style.display='block'; 
    tooltip.innerHTML = `<b>${dates[i]}</b><br>Fiyat: ${values[i].toFixed(2)}`; 
  };
  canvas.onmouseleave=()=>{ tooltip.style.display='none'; };
}

function openDetail(name){ 
  const item=DATA.find(i=>i.urun===name); 
  const alerts=JSON.parse(localStorage.getItem(ALERTS_KEY))||{}; 
  const a=alerts[name]||{}; 
  const kz=item.guncelDeger-item.toplamYatirim; 
  const totalG=DATA.reduce((a,b)=>a+b.guncelDeger,0); 
  const hist=(HISTORY_BY_URUN[name]||[]).slice(-30); 
  const last30=hist.map(h=>h.price); 
  const dates30=hist.map(h=>h.date.toLocaleDateString('tr-TR')); 
  const safeName=name.replace(/[^\w\-]/g,'_');
  document.getElementById("modal-inner").innerHTML = `
   <div style="padding:20px">
     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
       <h3 style="margin:0">${item.urun} Analizi</h3>
       <button onclick="document.getElementById('modal').classList.remove('show')" style="background:none; border:none; color:#fff; cursor:pointer; font-size:20px">âœ•</button>
     </div>
     <div class="sparkline-wrap" style="margin-bottom:14px">
       <div class="sparkline-title">Son 30 GÃ¼n Fiyat GrafiÄŸi</div>
       <canvas id="spark-${safeName}"></canvas>
       <div class="sparkline-tooltip"></div>
     </div>
     <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px">
       <div class="card"><div class="small">VarlÄ±k TÃ¼rÃ¼</div><div class="big">${item.tur || '-'}</div></div>
       <div class="card"><div class="small">PortfÃ¶y PayÄ±</div><div class="big">%${((item.guncelDeger/totalG)*100).toFixed(2)}</div></div>
     </div>
     <!-- diÄŸer modal iÃ§erikleri aynÄ± kaldÄ± -->
     <div class="card" style="margin-bottom:15px">
       <div class="small">UyarÄ± TanÄ±mla</div>
       <div style="display:grid; gap:10px; margin-top:10px">
         <input id="n-g" class="select" type="number" placeholder="DeÄŸer â‰¥" value="${a.guncel||''}">
         <input id="n-k" class="select" type="number" placeholder="KÃ¢r â‰¥" value="${a.kz||''}">
         <input id="n-p" class="select" type="number" placeholder="GÃ¼nlÃ¼k % â‰¥" value="${a.gp||''}">
         <button onclick="saveA('${item.urun.replace(/'/g, "\\'")}')" style="background:var(--accent); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold">KAYDET</button>
       </div>
     </div>
   </div>`;
  document.getElementById("modal").classList.add("show"); 
  try{ 
    const cnv=document.getElementById(`spark-${safeName}`); 
    if(cnv && last30 && last30.length){ drawSparkline(cnv, last30, dates30, '#3b82f6'); } 
  }catch(err){ console.warn('Sparkline hata', err); }
}

function saveA(n){ 
  const alerts=JSON.parse(localStorage.getItem(ALERTS_KEY))||{}; 
  alerts[n]={ 
    guncel:toNumber(document.getElementById("n-g").value), 
    kz:toNumber(document.getElementById("n-k").value), 
    gp:toNumber(document.getElementById("n-p").value)
  }; 
  localStorage.setItem(ALERTS_KEY, JSON.stringify(alerts)); 
  document.getElementById("modal").classList.remove("show"); 
  renderAll(); 
}

document.getElementById("sort-by").onchange = renderAll;
document.getElementById("auto-refresh").onchange = (e)=>{ const mins=Number(e.target.value); setAutoRefresh(mins); };
document.getElementById("search").oninput = (e)=>{ const v=e.target.value.toLowerCase(); document.querySelectorAll(".detail-item").forEach(el=> el.style.display = el.innerText.toLowerCase().includes(v) ? "flex":"none"); };
setAutoRefresh(5);
init();
</script>
</body>
</html>
