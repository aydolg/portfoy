<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Portf√∂y Dashboard Pro</title>

<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --line:#1f2937;
  --pos:#22c55e;
  --neg:#ef4444;
}

body{
  margin:0;
  background:var(--bg);
  color:#e5e7eb;
  font-family:system-ui, -apple-system, sans-serif;
}

h2{
  margin:24px 0 12px;
  font-size:13px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.7;
}

.sticky{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(11, 18, 32, 0.98);
  backdrop-filter: blur(12px);
  padding:16px;
  border-bottom: 1px solid var(--line);
}

.wrapper{ padding:20px; }

.grid-3{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:16px;
}
.grid-4{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:12px;
}

.card{
  background:linear-gradient(145deg, var(--card), #161e2e);
  border-radius:16px;
  padding:20px;
  border: 1px solid var(--line);
  transition: transform 0.2s;
}

.big{font-size:24px;font-weight:700;margin-top:4px; letter-spacing: -0.5px;}
.small{font-size:11px;font-weight:600;opacity:.5;text-transform: uppercase;}
.percent{font-size:13px; font-weight:bold; margin-left: 6px;}

.pos{color:var(--pos)}
.neg{color:var(--neg)}

.type-card{
  cursor:pointer;
  border:1px solid var(--line);
  opacity: 0.6;
}
.type-card.active{
  border-color:var(--pos);
  opacity: 1;
  background: rgba(34, 197, 94, 0.08);
}

#loading {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-weight: bold; opacity: 0.5;
}
</style>
</head>

<body>

<div id="loading">Veriler G√ºncelleniyor...</div>

<div id="app" style="display:none">
  <div class="sticky">
    <div class="grid-3" id="summary"></div>
    
    <h2>üíº Varlƒ±k Daƒüƒ±lƒ±mƒ±</h2>
    <div class="grid-4" id="types"></div>
  </div>

  <div class="wrapper">
    <h2>üìà D√∂nemsel Performans</h2>
    <div class="grid-3" id="periods"></div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLPFVZn0j8Ygu914QDGRCGKsVy88gWjdk7DFi-jWiydmqYsdGUE4hEAb-R_IBzQmtFZwoMJFcN6rlD/pub?gid=1050165900&single=true&output=csv";

let DATA=[], ACTIVE="ALL";

// CSV i√ßindeki gizli karakterleri ve tƒ±rnaklarƒ± temizleyen geli≈ümi≈ü parser
function parseCSV(text){
  const rows=[];
  let row=[], cur="", inQuotes=false;
  for(let i=0; i<text.length; i++){
    const c=text[i];
    if(c === '"') inQuotes = !inQuotes;
    else if(c === "," && !inQuotes){ row.push(cur.trim()); cur=""; }
    else if((c === "\n" || c === "\r") && !inQuotes){
      if(cur || row.length > 0){
        row.push(cur.trim()); rows.push(row);
        row=[]; cur="";
      }
    }
    else cur+=c;
  }
  if(cur || row.length > 0) { row.push(cur.trim()); rows.push(row); }
  return rows;
}

function toNumber(v){
  if(!v) return 0;
  // Hem nokta hem virg√ºl karma≈üasƒ±nƒ± √ß√∂zer
  let clean = v.replace(/\s/g, "").replace(/\./g, "").replace(",", ".");
  return parseFloat(clean) || 0;
}

function formatTRY(val) {
  return val.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " ‚Ç∫";
}

fetch(CSV_URL)
.then(r=>r.text())
.then(t=>{
  const rows = parseCSV(t.trim());
  const rawHeaders = rows.shift();
  // Header'lardaki g√∂r√ºnmez karakterleri (CR/LF) tamamen temizle
  const headers = rawHeaders.map(h => h.replace(/[\r\n]+/g, "").trim());

  DATA = rows.map(r => {
    let o = {};
    headers.forEach((h, i) => {
      if(!h) return;
      if(h === "urun" || h === "tur") o[h] = r[i] || "";
      else o[h] = toNumber(r[i]);
    });
    return o;
  });

  document.getElementById("loading").style.display="none";
  document.getElementById("app").style.display="block";
  renderAll();
});

const sum=(arr,key)=>arr.reduce((a,b)=>a+(b[key]||0),0);
const filterTur=t=>t==="ALL"?DATA:DATA.filter(x=>x.tur===t);

function renderAll(){
  renderSummary();
  renderTypes();
  renderPeriods();
}

function renderSummary(){
  const d = filterTur(ACTIVE);
  const t = sum(d, "toplamYatirim");
  const g = sum(d, "guncelDeger");
  const kz = g - t;
  const perc = t !== 0 ? ((kz / t) * 100).toFixed(2) : 0;
  
  const title = ACTIVE === "ALL" ? "Toplam Portf√∂y" : ACTIVE;

  document.getElementById("summary").innerHTML=`
    <div class="card">
      <div class="small">${title} Yatƒ±rƒ±mƒ±</div>
      <div class="big">${formatTRY(t)}</div>
    </div>
    <div class="card">
      <div class="small">G√ºncel Deƒüer</div>
      <div class="big">${formatTRY(g)}</div>
    </div>
    <div class="card ${kz>=0?"pos":"neg"}">
      <div class="small">Toplam K/Z</div>
      <div class="big">
        ${formatTRY(kz)} 
        <span class="percent">(${kz >= 0 ? '+':''}${perc}%)</span>
      </div>
    </div>`;
}

function renderTypes(){
  const c=document.getElementById("types");
  const turlar = [...new Set(DATA.map(item => item.tur))].filter(Boolean);
  
  let html = `<div class="card type-card ${ACTIVE==="ALL"?"active":""}" onclick="selectTur('ALL')">
                <div class="small">Hepsi</div>
                <div class="big">üè†</div>
              </div>`;
                 
  turlar.forEach(t=>{
    const v=sum(DATA.filter(x=>x.tur===t),"guncelDeger");
    html += `
      <div class="card type-card ${ACTIVE===t?"active":""}" onclick="selectTur('${t}')">
        <div class="small">${t}</div>
        <div class="big">${formatTRY(v)}</div>
      </div>`;
  });
  c.innerHTML = html;
}

function renderPeriods(){
  const d = filterTur(ACTIVE);
  const p = [
    ["G√ºnl√ºk","gunluk"], ["Haftalƒ±k","haftalik"], ["Aylƒ±k","aylik"],
    ["3 Aylƒ±k","ucAylik"], ["6 Aylƒ±k","altiAylik"], ["1 Yƒ±llƒ±k","birYillik"]
  ];

  document.getElementById("periods").innerHTML =
    p.map(x=>{
      const v = sum(d, x[1]);
      return `
      <div class="card ${v>=0?"pos":"neg"}">
        <div class="small">${x[0]} K/Z</div>
        <div class="big">${formatTRY(v)}</div>
      </div>`;
    }).join("");
}

function selectTur(t){
  ACTIVE = (ACTIVE===t) ? "ALL" : t;
  renderAll();
}
</script>

</body>
</html>
