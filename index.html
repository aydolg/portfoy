<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Ultimate PortfÃ¶y Terminali</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Inter,Arial;background:#0f172a;color:#e5e7eb;margin:20px}
h1{margin-bottom:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.card{background:#020617;padding:16px;border-radius:12px;box-shadow:0 0 0 1px #1e293b}
.good{color:#22c55e}.bad{color:#ef4444}.mid{color:#eab308}
canvas{background:#020617;border-radius:12px;padding:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #1e293b;font-size:13px}
th{text-align:left;color:#94a3b8}
</style>
</head>
<body>
<h1>ğŸ“Š Ultimate PortfÃ¶y Terminali</h1>

<div class="grid" id="summary"></div>

<div class="grid" style="margin-top:20px">
  <div class="card"><canvas id="perfChart"></canvas></div>
  <div class="card"><canvas id="distChart"></canvas></div>
</div>

<div class="grid" style="margin-top:20px">
  <div class="card"><h3>ğŸ”¥ En Ä°yi 5</h3><table id="best"></table></div>
  <div class="card"><h3>ğŸ’¥ En KÃ¶tÃ¼ 5</h3><table id="worst"></table></div>
</div>

<div class="card" style="margin-top:20px" id="health"></div>

<script>
const PORTFOY_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
const DATA_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=2136415211&single=true&output=csv";
const MACRO_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=1018386005&single=true&output=csv";

function num(v){return Number(String(v||0).replace(/\./g,"").replace(",","."))||0}
async function loadCSV(u){const t=await (await fetch(u)).text();const l=t.replace(/\r/g,"").split("\n").filter(x=>x.trim());const d=l[0].includes(";")?";":",";const h=l[0].split(d);return l.slice(1).map(r=>{const c=r.split(d);let o={};h.forEach((x,i)=>o[x]=c[i]);return o})}

(async()=>{
const portfoy=await loadCSV(PORTFOY_CSV)
const data=await loadCSV(DATA_CSV)
const macro=await loadCSV(MACRO_CSV)

let toplam=0,maliyet=0
portfoy.forEach(r=>{toplam+=num(r['GÃ¼ncel Tutar']||r['Deger']);maliyet+=num(r['Maliyet'])})
const kar=toplam-maliyet
const enf=num((macro.find(x=>String(x.KOD).includes('ENFL'))||{}).DEGER)
const reel=((kar/maliyet)*100)-enf

summary.innerHTML=`
<div class=card><b>Toplam</b><h2>${toplam.toLocaleString()} â‚º</h2></div>
<div class=card><b>KÃ¢r/Zarar</b><h2 class=${kar>=0?'good':'bad'}>${kar.toLocaleString()} â‚º</h2></div>
<div class=card><b>Reel Getiri</b><h2 class=${reel>=0?'good':'bad'}>%${reel.toFixed(2)}</h2></div>`

// Grafik
new Chart(perfChart,{type:'line',data:{labels:data.map(d=>d.Tarih),datasets:[{label:'PortfÃ¶y',data:data.map(d=>num(d.Toplam)),borderColor:'#22c55e'}]},options:{plugins:{legend:{labels:{color:'#e5e7eb'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}})

// DaÄŸÄ±lÄ±m
let grp={}
portfoy.forEach(r=>grp[r.TÃ¼r]=(grp[r.TÃ¼r]||0)+num(r['GÃ¼ncel Tutar']))
new Chart(distChart,{type:'doughnut',data:{labels:Object.keys(grp),datasets:[{data:Object.values(grp)}]},options:{plugins:{legend:{labels:{color:'#e5e7eb'}}}}})

// En iyi / kÃ¶tÃ¼
const sorted=[...portfoy].sort((a,b)=>num(b.Getiri)-num(a.Getiri))
function fill(tbl,arr){tbl.innerHTML='<tr><th>VarlÄ±k</th><th>%</th></tr>'+arr.map(r=>`<tr><td>${r.Ad}</td><td>${num(r.Getiri).toFixed(2)}</td></tr>`).join('')}
fill(best,sorted.slice(0,5))
fill(worst,sorted.slice(-5))

// SaÄŸlÄ±k skoru
let risk=Object.values(grp).sort((a,b)=>b-a)[0]/toplam*100
let durum=risk>50?'ğŸ”´ Agresif':risk>30?'ğŸŸ¡ Dengeli':'ğŸŸ¢ Defansif'
health.innerHTML=`<h3>âš–ï¸ PortfÃ¶y SaÄŸlÄ±ÄŸÄ±</h3><p>En bÃ¼yÃ¼k aÄŸÄ±rlÄ±k: %${risk.toFixed(1)}</p><h2>${durum}</h2>`

})();
</script>
</body>
</html>
