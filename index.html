
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Elite Portföy Terminali v3.1</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030508; --card-bg: rgba(16, 20, 29, 0.95);
      --accent: #00ff9d; --red: #ff3b5c; --text: #ffffff;
      --text-muted: #94a3b8; --border: rgba(255, 255, 255, 0.1);
    }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; line-height: 1.4; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* PERFORMANS PANELİ */
    .perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .perf-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .perf-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }

    /* AKAN YAZI */
    .ticker-wrap { width: 100%; overflow: hidden; background: rgba(16, 20, 29, 0.5); border-radius: 10px; border: 1px solid var(--border); padding: 12px 0; margin-bottom: 15px; white-space: nowrap; }
    .ticker { display: inline-flex; animation: ticker-move 35s linear infinite; }
    .ticker-item { padding: 0 40px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    @keyframes ticker-move { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* ANA KARTLAR VE Z-INDEX */
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; position: relative; }
    @media (max-width: 600px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
    .card { background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px 12px; border-radius: 18px; border: 1px solid var(--border); cursor: pointer; position: relative; border-left: 4px solid #334155; transition: 0.3s; z-index: 1; }
    .card.active { border-color: var(--accent); z-index: 999 !important; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .card span { color: var(--text-muted); font-size: 0.6rem; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .card .value { font-size: 0.95rem; font-weight: 800; }
    .card.up-card { border-left-color: var(--accent); }
    .card.down-card { border-left-color: var(--red); }

    /* AÇILIR LİSTE */
    .dist-container { display: none; background: #11151c; border: 1px solid var(--border); border-radius: 14px; padding: 10px; margin-top: 10px; position: absolute; left: 0; right: 0; top: 100%; z-index: 1000; width: 100%; box-sizing: border-box; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
    .card.active .dist-container { display: block; }
    .dist-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; font-weight: 600; }

    /* GRAFİK VE MARKET */
    .chart-block { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; }
    .market-block { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 5px 15px; margin-bottom: 25px; }
    .market-header { padding: 12px 0 8px 0; font-size: 0.65rem; font-weight: 800; color: var(--accent); letter-spacing: 1px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    .m-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

    /* ASSET DETAY (ÖNERİLEN TAM YAPI) */
    .asset-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 14px; margin-bottom: 8px; overflow: hidden; }
    .asset-main { padding: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .asset-expand { display: none; padding: 15px; grid-template-columns: repeat(2, 1fr); gap: 10px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    @media (min-width: 600px) { .asset-expand { grid-template-columns: repeat(4, 1fr); } }
    .det-box { display: flex; flex-direction: column; background: rgba(255,255,255,0.02); padding: 8px; border-radius: 8px; }
    .det-lbl { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; font-weight: 800; }
    .det-val { font-size: 0.75rem; font-weight: 700; color: #f1f5f9; }

    .up { color: var(--accent); } .down { color: var(--red); }

    /* Basit yükleniyor katmanı */
    #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;flex-direction:column;}
    .spinner{width:46px;height:46px;border:3px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div style="margin-top:10px;color:var(--accent);font-weight:700">Yükleniyor...</div>
</div>

<div class="container">
  <div class="perf-grid">
    <div id="bestPerf" class="perf-box best">
      <div class="perf-label">Günün Yıldızı</div>
      <div class="up" style="font-weight:800; font-size:0.8rem;">...</div>
    </div>
    <div id="worstPerf" class="perf-box worst">
      <div class="perf-label">Günün Zayıfı</div>
      <div class="down" style="font-weight:800; font-size:0.8rem;">...</div>
    </div>
  </div>

  <div class="summary-grid" id="summaryGrid"></div>
  <div class="ticker-wrap"><div class="ticker" id="tickerContent">Veriler senkronize ediliyor...</div></div>

  <div class="chart-block">
    <div class="market-header">VARLIK DAĞILIMI (%)</div>
    <div style="height: 200px;"><canvas id="allocationChart"></canvas></div>
  </div>

  <div class="market-block">
    <div class="market-header">GÜNCEL FİYATLAR</div>
    <div id="marketRows"></div>
  </div>

  <div id="detailSection" style="display:none; padding-bottom:100px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding: 0 5px;">
      <div id="detailTitle" style="font-weight:800; color:var(--accent); font-size:0.8rem;">VARLIK ANALİZİ</div>
      <div onclick="closeAll()" style="color:var(--red); font-size:0.7rem; font-weight:bold; cursor:pointer;">[KAPAT]</div>
    </div>
    <div id="assetGrid"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
  /* ==============================
     CONFIG
  =============================== */
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
  const PROXY = "https://corsproxy.io/?";

  let globalData = [];
  let allocationChart = null;
  let currentFetch = null;
  let cleanAnomalies = 0;

  /* ==============================
     HELPERS
  =============================== */
  const palette = ['#00ff9d','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#22d3ee','#84cc16','#d946ef','#f97316','#06b6d4'];
  const colorMap = new Map();
  function colorFor(label){
    if(!colorMap.has(label)) colorMap.set(label, palette[colorMap.size % palette.length]);
    return colorMap.get(label);
  }

  function showLoading(v){
    document.getElementById('loadingOverlay').style.display = v ? 'flex' : 'none';
  }

  function normalizeHeader(h) {
    if (!h) return '';
    let s = String(h).trim().toLowerCase();
    const map = { 'ı':'i','ğ':'g','ü':'u','ş':'s','ö':'o','ç':'c','İ':'i','Ğ':'g','Ü':'u','Ş':'s','Ö':'o','Ç':'c' };
    s = s.replace(/[ığüşöçİĞÜŞÖÇ]/g, c => map[c] || c);
    s = s.replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    return s;
  }

  function normalizeText(t){
    if(!t) return '';
    const map = { 'ı':'i','ğ':'g','ü':'u','ş':'s','ö':'o','ç':'c','İ':'i','Ğ':'g','Ü':'u','Ş':'s','Ö':'o','Ç':'c' };
    return String(t).toLowerCase().replace(/[ığüşöçİĞÜŞÖÇ]/g, c => map[c] || c);
  }

  function clean(v){
    if(v === null || v === undefined) return 0;
    let s = String(v).trim();
    if(!s || s === '-' || s === '0,00' || s.includes('#')) return 0;

    // parantezli negatif: (1.234,56)
    let negative = false;
    if(s.startsWith('(') && s.endsWith(')')){
      negative = true;
      s = s.slice(1,-1);
    }

    try{
      s = s
        .replace(/TL|₺|\$|USD|€|EUR|£|GBP/gi,'')
        .replace(/%/g,'')
        .replace(/\s+/g,'')
        .replace(/\./g,'')       // binlik
        .replace(',', '.')       // ondalık
        .replace(/[^\d.-]/g,'');

      if(s.startsWith('-')){ negative = !negative; s = s.slice(1); }

      const num = parseFloat(s);
      if(Number.isFinite(num) && Math.abs(num) <= 1e12){
        return negative ? -num : num;
      }
      cleanAnomalies++;
      console.warn('clean() anomalisi:', v, '→', s);
      return 0;
    }catch(e){
      cleanAnomalies++;
      console.error('clean() hatası:', v, e);
      return 0;
    }
  }

  function safeDailyPct(gKZ, tutar){
    const g = Number(gKZ), t = Number(tutar);
    if(!Number.isFinite(g) || !Number.isFinite(t) || t <= 0) return 0;
    const prev = t - g;
    if(!Number.isFinite(prev) || Math.abs(prev) < 1) return 0;
    let pct = (g / prev) * 100;
    if(!Number.isFinite(pct) || Math.abs(pct) > 500) return 0;
    return pct;
  }

  function getDaysBetween(dateStr) {
    if (!dateStr || dateStr.length < 5) return "-";
    try {
      const parts = dateStr.split('.');
      const d = new Date(parts[2], parts[1]-1, parts[0]);
      const diff = Math.floor((new Date() - d) / (1000 * 60 * 60 * 24));
      return diff >= 0 ? diff + " Gün" : "-";
    } catch(e) { return "-"; }
  }

  /* ==============================
     FETCH (Failover + Abort)
  =============================== */
  async function fetchWithFallback(url, options = {}){
    // Birincil dene
    try{
      const res = await fetch(url, { cache: "no-store", ...options });
      if(res.ok) return res;
      throw new Error(`HTTP ${res.status}`);
    }catch(e){
      // Proxy ile dene
      const viaProxy = PROXY + encodeURIComponent(url);
      const res2 = await fetch(viaProxy, { cache: "no-store", ...options });
      if(!res2.ok) throw new Error(`Proxy HTTP ${res2.status}`);
      return res2;
    }
  }

  async function fetchData(){
    showLoading(true);
    if(currentFetch) currentFetch.abort();
    currentFetch = new AbortController();

    try{
      const res = await fetchWithFallback(SHEET_CSV_URL, { signal: currentFetch.signal });
      const text = await res.text();

      Papa.parse(text, {
        header: true,
        delimiter: ',',
        quoteChar: '"',
        escapeChar: '"',
        skipEmptyLines: true,
        dynamicTyping: false,
        transformHeader: normalizeHeader,
        beforeFirstChunk: (chunk) => chunk.replace(/^\uFEFF?/, '').trim(),
        complete: (result)=>{
          const rows = (result.data || []);
          buildDataFromRows(rows);
        }
      });

    }catch(err){
      if(err.name !== 'AbortError'){
        console.error('Veri alınamadı:', err);
      }
    }finally{
      showLoading(false);
      currentFetch = null;
    }
  }

  /* ==============================
     CSV → DATA
  =============================== */
  function buildDataFromRows(rows){
    cleanAnomalies = 0;

    const mapped = rows.map(r=>{
      const item = {
        ad: (r['varlik'] || r['varlık'] || '').toString().trim(),
        tur: (r['tur'] || r['tür'] || 'Diğer').toString().trim(),
        alisTarihi: r['alistarihi'] || r['alıştarihi'] || '',
        vade: r['vadetarihi'] || '',
        adet: clean(r['adet']),
        aFiyat: clean(r['alisfiyati'] || r['alışfiyatı']),
        yatirim: clean(r['yatirimtutari'] || r['yatırımtutarı']),
        fiyat: clean(r['guncelfiyat'] || r['güncelfiyat']),
        tutar: clean(r['gunceltutar'] || r['günceltutar']),
        gKZ: clean(r['gkz']),
        hKZ: clean(r['hkz']),
        aKZ: clean(r['akz']),
        tKZ: clean(r['tkz'])
      };
      return item;
    });

    const zeros = [];
    mapped.forEach(x => { if (x.ad && !x.tutar) zeros.push({ ad:x.ad, fiyat:x.fiyat, tutar:x.tutar }); });
    if (zeros.length) console.warn('Tutarı 0 kalan ilk kayıtlar:', zeros.slice(0,10));

    // Portföyü hesaplamada 0 tutarları da göstermek isteyebilirsin.
    // Ancak dağılım ve performans için anlamlısı >0.
    globalData = mapped;

    console.log(`CSV satır: ${rows.length} | temizlenen anomaliler: ${cleanAnomalies} | anlamlı (tutar>0): ${mapped.filter(d=>d.tutar>0).length}`);

    renderAll();
  }

  /* ==============================
     RENDER
  =============================== */
  function renderAll() {
    // Toplamlar ve gruplar
    const totals = { yatirim:0, tutar:0, tKZ:0, gKZ:0, hKZ:0, aKZ:0 };
    const groups = {};
    globalData.forEach(item => {
      if (!groups[item.tur]) groups[item.tur] = { yatirim:0, tutar:0, tKZ:0, gKZ:0, hKZ:0, aKZ:0 };
      Object.keys(totals).forEach(key => { 
        groups[item.tur][key] += Number(item[key]) || 0;
        totals[key] += Number(item[key]) || 0;
      });
    });

    renderSummaries(totals, groups);
    renderTicker();
    renderMarketRows();
    renderPerformance();
    updateChart(groups);
  }

  function renderSummaries(totals, groups) {
    const summaryEl = document.getElementById("summaryGrid");
    const keys = [
      {id:'yatirim', l:'Yatırım'},
      {id:'tutar', l:'Portföy'},
      {id:'tKZ', l:'Toplam K/Z'},
      {id:'gKZ', l:'Günlük K/Z'},
      {id:'hKZ', l:'Haftalık K/Z'},
      {id:'aKZ', l:'Aylık K/Z'}
    ];

    summaryEl.innerHTML = keys.map(k => {
      const val = totals[k.id], isKZ = k.id.includes('KZ');
      const cardStatus = isKZ ? (val >= 0 ? 'up-card' : 'down-card') : '';
      const color = isKZ ? (val >= 0 ? 'up' : 'down') : '';
      const sortedTur = Object.keys(groups).sort((a,b) => groups[b][k.id] - groups[a][k.id]);
      let distHtml = sortedTur.map(t => `
        <div class="dist-row" onclick="event.stopPropagation(); showDetails('${t.replace(/'/g,"\\'")}')">
          <span>${t}</span>
          <span class="${groups[t][k.id] >= 0 ? 'up':'down'}">${groups[t][k.id].toLocaleString('tr-TR')} ₺</span>
        </div>`).join('');
      return `
        <div class="card ${cardStatus}" onclick="toggleCard(this)">
          <span>${k.l}</span>
          <div class="value ${color}">${val.toLocaleString('tr-TR')} ₺</div>
          <div class="dist-container">${distHtml}</div>
        </div>`;
    }).join('');
  }

  function renderPerformance() {
    const sorted = globalData
      .filter(d => d.tutar > 50)
      .sort((a, b) => safeDailyPct(b.gKZ, b.tutar) - safeDailyPct(a.gKZ, a.tutar));

    const bestBox = document.getElementById("bestPerf").querySelector('.up');
    const worstBox = document.getElementById("worstPerf").querySelector('.down');

    if(sorted.length > 0) {
      const best = sorted[0];
      const worst = sorted[sorted.length - 1];
      bestBox.textContent = `${best.ad}  (%${safeDailyPct(best.gKZ,best.tutar).toFixed(2)})`;
      worstBox.textContent = `${worst.ad}  (%${safeDailyPct(worst.gKZ,worst.tutar).toFixed(2)})`;
    } else {
      bestBox.textContent = 'Veri yok';
      worstBox.textContent = 'Veri yok';
    }
  }

  function updateChart(groups) {
    const ctx = document.getElementById('allocationChart').getContext('2d');
    const labels = Object.keys(groups);
    const dataVals = labels.map(l => groups[l].tutar);
    const colors = labels.map(colorFor);

    if (allocationChart) allocationChart.destroy();
    allocationChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: dataVals,
          backgroundColor: colors,
          borderWidth: 2, borderColor: '#030508'
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } },
          tooltip: { callbacks: { label: (c) => `${c.label}: ${Number(c.raw).toLocaleString('tr-TR')} ₺` } }
        }
      }
    });
  }

  function renderMarketRows() {
    const targets = ["USDTRY", "EURTRY", "ALTIN/USD", "ALTIN/TL", "GRAMALTIN", "ENFLASYON", "MEVDUAT"];
    const rowsHtml = targets.map(name => {
      const n = normalizeText(name).replace(/\s+/g,'');
      const found = globalData.find(d => normalizeText(d.ad).replace(/\s+/g,'') === n);
      if(!found) return "";
      return `
        <div class="m-row">
          <span style="font-size:0.75rem; font-weight:700;">${name}</span>
          <span class="${found.gKZ >= 0 ? 'up' : 'down'}" style="font-weight:800; font-family:monospace;">
            ${Number(found.fiyat).toLocaleString('tr-TR')}
          </span>
        </div>`;
    }).join('');
    document.getElementById("marketRows").innerHTML = rowsHtml;
  }

  function renderTicker() {
    const ticker = document.getElementById("tickerContent");
    const meaningful = globalData.filter(a => a.tutar > 10);
    const moves = meaningful.map(a => {
      const y = safeDailyPct(a.gKZ, a.tutar);
      const dir = y >= 0 ? '▲' : '▼';
      return `<div class="ticker-item"><span>${a.ad}</span><span class="${y>=0?'up':'down'}">${dir} %${Math.abs(y).toFixed(2)}</span></div>`;
    });
    // Sürekli akış için üç kez tekrarla
    ticker.innerHTML = moves.join('') + moves.join('') + moves.join('');
    // Eleman sayısına göre hız
    ticker.style.animationDuration = `${Math.max(meaningful.length * 4, 25)}s`;
  }

  function showDetails(tur) {
    const sect = document.getElementById("detailSection"), grid = document.getElementById("assetGrid");
    sect.style.display = "block";
    document.getElementById("detailTitle").textContent = `VARLIK ANALİZİ — ${tur}`;

    const items = globalData.filter(d => d.tur === tur).sort((a,b) => b.tutar - a.tutar);
    grid.innerHTML = items.map(a => `
      <div class="asset-item">
        <div class="asset-main" onclick="toggleAsset(this)">
          <div style="font-weight:700; font-size:0.8rem;">${a.ad}</div>
          <div style="text-align:right">
            <div class="up" style="font-weight:800; font-size:0.85rem;">${Number(a.tutar).toLocaleString('tr-TR')} ₺</div>
            <div class="${a.tKZ>=0?'up':'down'}" style="font-size:0.6rem;">${Number(a.tKZ).toLocaleString('tr-TR')} ₺</div>
          </div>
        </div>
        <div class="asset-expand">
          <div class="det-box"><span class="det-lbl">Adet</span><span class="det-val">${Number(a.adet).toLocaleString('tr-TR')}</span></div>
          <div class="det-box"><span class="det-lbl">Alış Fiyatı</span><span class="det-val">${Number(a.aFiyat).toLocaleString('tr-TR')}</span></div>
          <div class="det-box"><span class="det-lbl">Yatırım</span><span class="det-val">${Number(a.yatirim).toLocaleString('tr-TR')} ₺</span></div>
          <div class="det-box"><span class="det-lbl">Süre</span><span class="det-val">${getDaysBetween(a.alisTarihi)}</span></div>
          <div class="det-box"><span class="det-lbl">Günlük K/Z</span><span class="det-val ${a.gKZ>=0?'up':'down'}">${Number(a.gKZ).toLocaleString('tr-TR')} ₺</span></div>
          <div class="det-box"><span class="det-lbl">Haftalık K/Z</span><span class="det-val ${a.hKZ>=0?'up':'down'}">${Number(a.hKZ).toLocaleString('tr-TR')} ₺</span></div>
          <div class="det-box"><span class="det-lbl">Aylık K/Z</span><span class="det-val ${a.aKZ>=0?'up':'down'}">${Number(a.aKZ).toLocaleString('tr-TR')} ₺</span></div>
          <div class="det-box"><span class="det-lbl">Toplam K/Z</span><span class="det-val ${a.tKZ>=0?'up':'down'}">${Number(a.tKZ).toLocaleString('tr-TR')} ₺</span></div>
        </div>
      </div>`).join('');
    sect.scrollIntoView({ behavior: 'smooth' });
  }

  function toggleCard(el) {
    const active = el.classList.contains('active');
    document.querySelectorAll('.card').forEach(c => { c.classList.remove('active'); c.style.zIndex = "1"; });
    if (!active) { el.classList.add('active'); el.style.zIndex = "999"; }
  }

  function toggleAsset(el) {
    const exp = el.parentElement.querySelector('.asset-expand');
    const open = exp.style.display === 'grid';
    document.querySelectorAll('.asset-expand').forEach(d => d.style.display = 'none');
    exp.style.display = open ? 'none' : 'grid';
  }

  function closeAll() {
    document.getElementById('detailSection').style.display = 'none';
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
  }

  // Başlat
  fetchData();
  setInterval(() => {
    // detay/scroll sırasında yenilemek istemiyorsan buraya koşul ekleyebilirsin
    fetchData();
  }, 300000);
</script>
</body>
</html>
``
