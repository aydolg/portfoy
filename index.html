<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Varlık Yönetim Paneli</title>
  <style>
    :root {
      --bg: #0b0e11; --card: #181a20; --header: #2b2f36; --text: #e2e8f0;
      --text-muted: #848e9c; --green: #0ecb81; --red: #f6465d; --accent: #f0b90b; --border: #2d3339;
    }

    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Üst Kartlar ve Dağılım Pop-up */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); position: relative; cursor: default; }
    .card span { display: block; color: var(--text-muted); font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; }
    .card div { font-size: 1.4rem; font-weight: 700; }

    /* Hover Dağılım Penceresi */
    .distribution-popup {
      display: none; position: absolute; top: 100%; left: 0; width: 250px;
      background: #2b2f36; border: 1px solid var(--accent); border-radius: 8px;
      padding: 15px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .card:hover .distribution-popup { display: block; }
    .dist-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; }

    /* Grup Kartları */
    .group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .group-card { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s; }
    .group-card:hover { border-color: var(--accent); }
    
    .group-header { 
      padding: 20px; background: #1e2329; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
    }
    .group-title { font-size: 1.1rem; font-weight: bold; color: var(--accent); }
    .group-summary { text-align: right; }
    .group-summary div { font-size: 0.9rem; font-weight: 600; }
    .group-summary small { color: var(--text-muted); font-size: 0.7rem; }

    /* Detay Listesi (Accordion) */
    .group-details { display: none; padding: 10px; background: #14171c; border-top: 1px solid var(--border); }
    .group-card.active .group-details { display: block; }
    
    .asset-row {
      display: flex; justify-content: space-between; padding: 10px;
      border-bottom: 1px solid #2d3339; font-size: 0.85rem;
    }
    .asset-row:last-child { border-bottom: none; }
    .up { color: var(--green); } .down { color: var(--red); }
  </style>
</head>
<body>

<div class="container">
  <div class="summary-grid">
    <div class="card" id="invCard">
      <span>Toplam Yatırım</span>
      <div id="totInv">0 ₺</div>
      <div class="distribution-popup" id="distList">
        </div>
    </div>
    <div class="card"><span>Güncel Değer</span><div id="totCur">0 ₺</div></div>
    <div class="card"><span>Günlük K/Z</span><div id="totDaily">0 ₺</div></div>
    <div class="card"><span>Haftalık K/Z</span><div id="totWeekly">0 ₺</div></div>
    <div class="card"><span>Toplam K/Z</span><div id="totKZ">0 ₺</div></div>
  </div>

  <div class="group-grid" id="groupGrid">
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
  
  function clean(v) {
    if (!v || v.includes('#N/A')) return 0;
    return parseFloat(v.replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]+/g, '')) || 0;
  }

  Papa.parse(csvUrl, {
    download: true,
    complete: function(res) {
      const rows = res.data.slice(1).filter(r => r[0] && r[0].trim() !== "");
      const data = rows.map(r => ({
        ad: r[0], tur: r[1], tarih: r[2], adet: clean(r[3]), alis: clean(r[4]),
        yatirim: clean(r[5]), fiyat: clean(r[6]), tutar: clean(r[7]),
        gKZ: clean(r[8]), hKZ: clean(r[9]), tKZ: clean(r[10])
      }));

      renderDashboard(data);
    }
  });

  function renderDashboard(data) {
    const groups = {};
    let totalInv = 0, totalCur = 0, totalD = 0, totalW = 0, totalKZ = 0;

    data.forEach(item => {
      if (!groups[item.tur]) groups[item.tur] = { assets: [], inv: 0, cur: 0, kz: 0 };
      groups[item.tur].assets.push(item);
      groups[item.tur].inv += item.yatirim;
      groups[item.tur].cur += item.tutar;
      groups[item.tur].kz += item.tKZ;
      
      totalInv += item.yatirim;
      totalCur += item.tutar;
      totalD += item.gKZ;
      totalW += item.hKZ;
      totalKZ += item.tKZ;
    });

    // Üst Kartları Doldur
    document.getElementById("totInv").innerText = totalInv.toLocaleString('tr-TR') + " ₺";
    document.getElementById("totCur").innerText = totalCur.toLocaleString('tr-TR') + " ₺";
    document.getElementById("totDaily").innerText = totalD.toLocaleString('tr-TR') + " ₺";
    document.getElementById("totWeekly").innerText = totalW.toLocaleString('tr-TR') + " ₺";
    document.getElementById("totKZ").innerText = totalKZ.toLocaleString('tr-TR') + " ₺";
    
    // Dağılım Pop-up Doldur
    const distList = document.getElementById("distList");
    distList.innerHTML = "<strong>Varlık Dağılımı</strong><hr style='border:0;border-top:1px solid #444;margin:10px 0'>";
    Object.keys(groups).forEach(key => {
      const perc = ((groups[key].inv / totalInv) * 100).toFixed(1);
      distList.innerHTML += `<div class="dist-item"><span>${key}</span><span>%${perc}</span></div>`;
    });

    // Grup Kartlarını Oluştur
    const grid = document.getElementById("groupGrid");
    grid.innerHTML = "";
    Object.keys(groups).forEach(key => {
      const g = groups[key];
      const card = document.createElement("div");
      card.className = "group-card";
      card.innerHTML = `
        <div class="group-header" onclick="this.parentElement.classList.toggle('active')">
          <div class="group-title">${key}</div>
          <div class="group-summary">
            <div>${g.cur.toLocaleString('tr-TR')} ₺</div>
            <small class="${g.kz >= 0 ? 'up' : 'down'}">K/Z: ${g.kz.toLocaleString('tr-TR')} ₺</small>
          </div>
        </div>
        <div class="group-details">
          ${g.assets.map(a => `
            <div class="asset-row">
              <span><strong>${a.ad}</strong><br><small>${a.adet} Adet</small></span>
              <span style="text-align:right">
                ${a.tutar.toLocaleString('tr-TR')} ₺<br>
                <small class="${a.tKZ >= 0 ? 'up' : 'down'}">${a.tKZ.toLocaleString('tr-TR')} ₺</small>
              </span>
            </div>
          `).join('')}
        </div>
      `;
      grid.appendChild(card);
    });
  }
</script>

</body>
</html>
