<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Elite Portföy Terminali v3.1</title>

  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #030508; --card-bg: rgba(16, 20, 29, 0.95);
      --accent: #00ff9d; --red: #ff3b5c; --text: #ffffff;
      --text-muted: #94a3b8; --border: rgba(255, 255, 255, 0.1);
    }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; line-height: 1.4; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* PERFORMANS PANELİ */
    .perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .perf-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .perf-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }

    /* HEADER BİLGİ */
    .top-info { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px; }
    #lastUpdated{color:var(--text-muted);font-size:12px;}

    /* AKAN YAZI */
    .ticker-wrap { width: 100%; overflow: hidden; background: rgba(16, 20, 29, 0.5); border-radius: 10px; border: 1px solid var(--border); padding: 12px 0; margin: 10px 0 15px; white-space: nowrap; }
    .ticker { display: inline-flex; animation: ticker-move 35s linear infinite; }
    .ticker-item { padding: 0 40px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    @keyframes ticker-move { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* ANA KARTLAR VE Z-INDEX */
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; position: relative; }
    @media (max-width: 600px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
    .card { background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px 12px; border-radius: 18px; border: 1px solid var(--border); cursor: pointer; position: relative; border-left: 4px solid #334155; transition: 0.3s; z-index: 1; }
    .card.active { border-color: var(--accent); z-index: 999 !important; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .card span { color: var(--text-muted); font-size: 0.6rem; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .card .value { font-size: 0.95rem; font-weight: 800; }
    .card.up-card { border-left-color: var(--accent); }
    .card.down-card { border-left-color: var(--red); }

    /* AÇILIR LİSTE */
    .dist-container { display: none; background: #11151c; border: 1px solid var(--border); border-radius: 14px; padding: 10px; margin-top: 10px; position: absolute; left: 0; right: 0; top: 100%; z-index: 1000; width: 100%; box-sizing: border-box; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
    .card.active .dist-container { display: block; }
    .dist-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; font-weight: 600; }

    /* TÜR SEKMELERİ */
    .type-tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 20px; }
    .type-tab { background: rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; }
    .type-tab.active { color:#111; background: var(--accent); border-color: var(--accent); font-weight:800; }

    /* GRAFİK VE MARKET */
    .chart-block { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; }
    .market-block { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 5px 15px; margin-bottom: 25px; }
    .market-header { padding: 12px 0 8px 0; font-size: 0.65rem; font-weight: 800; color: var(--accent); letter-spacing: 1px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    .m-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

    /* ASSET DETAY */
    .asset-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 14px; margin-bottom: 8px; overflow: hidden; }
    .asset-main { padding: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .asset-expand { display: none; padding: 15px; grid-template-columns: repeat(2, 1fr); gap: 10px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    @media (min-width: 600px) { .asset-expand { grid-template-columns: repeat(4, 1fr); } }
    .det-box { display: flex; flex-direction: column; background: rgba(255,255,255,0.02); padding: 8px; border-radius: 8px; }
    .det-lbl { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; font-weight: 800; }
    .det-val { font-size: 0.75rem; font-weight: 700; color: #f1f5f9; }

    .up { color: var(--accent); } .down { color: var(--red); }

    /* YÜKLENİYOR KATMANI */
    #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;flex-direction:column;}
    .spinner{width:46px;height:46px;border:3px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div style="margin-top:10px;color:var(--accent);font-weight:700">Yükleniyor...</div>
</div>

<div class="container">
  <div class="perf-grid">
    <div id="bestPerf" class="perf-box best">
      <div class="perf-label">Günün Yıldızı</div>
      <div class="up" style="font-weight:800; font-size:0.8rem;">...</div>
    </div>
    <div id="worstPerf" class="perf-box worst">
      <div class="perf-label">Günün Zayıfı</div>
      <div class="down" style="font-weight:800; font-size:0.8rem;">...</div>
    </div>
  </div>

  <div class="top-info">
    <div id="lastUpdated">Son güncelleme: -</div>
    <div style="font-size:12px;color:var(--text-muted)">v3.1 • Elite Portföy Terminali</div>
  </div>

  <div class="summary-grid" id="summaryGrid"></div>

  <div class="ticker-wrap"><div class="ticker" id="tickerContent">Veriler senkronize ediliyor...</div></div>

  <div class="type-tabs" id="typeTabs"></div>

  <div class="chart-block">
    <div class="market-header">VARLIK DAĞILIMI (%)</div>
    <div style="height: 220px;"><canvas id="allocationChart"></canvas></div>
  </div>

  <div class="market-block">
    <div class="market-header">GÜNCEL FİYATLAR</div>
    <div id="marketRows"></div>
  </div>

  <div id="detailSection" style="display:none; padding-bottom:100px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding: 0 5px;">
      <div id="detailTitle" style="font-weight:800; color:var(--accent); font-size:0.8rem;">VARLIK ANALİZİ</div>
      <div onclick="closeAll()" style="color:var(--red); font-size:0.7rem; font-weight:bold; cursor:pointer;">[KAPAT]</div>
    </div>
    <div id="assetGrid"></div>
  </div>
</div>

<script>
  /* ============== CONFIG ================= */
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
  const PROXY = "https://corsproxy.io/?";

  let globalData = [];
  let allocationChart = null;
  let currentFetch = null;

  /* ============== HELPERS ================= */
  const palette = ['#00ff9d','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#22d3ee','#84cc16','#d946ef','#f97316','#06b6d4'];
  const colorMap = new Map();
  function colorFor(label){
    if(!colorMap.has(label)) colorMap.set(label, palette[colorMap.size % palette.length]);
    return colorMap.get(label);
  }
  function setLastUpdated(d = new Date()){
    document.getElementById('lastUpdated').textContent = 'Son güncelleme: ' + d.toLocaleString('tr-TR');
  }
  function showLoading(v){ document.getElementById('loadingOverlay').style.display = v ? 'flex' : 'none'; }

  // Başlık & metin normalize
  function normalizeHeader(h) {
    if (!h) return '';
    let s = String(h).trim().toLowerCase();
    const map = { 'ı':'i','ğ':'g','ü':'u','ş':'s','ö':'o','ç':'c','İ':'i','Ğ':'g','Ü':'u','Ş':'s','Ö':'o','Ç':'c' };
    s = s.replace(/[ığüşöçİĞÜŞÖÇ]/g, c => map[c] || c);
    s = s.replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    return s;
  }
  function normalizeText(t){
    if(!t) return '';
    const map = { 'ı':'i','ğ':'g','ü':'u','ş':'s','ö':'o','ç':'c','İ':'i','Ğ':'g','Ü':'u','Ş':'s','Ö':'o','Ç':'c' };
    return String(t).toLowerCase().replace(/[ığüşöçİĞÜŞÖÇ]/g, c => map[c] || c);
  }

  // Sayı biçimleyici
  function fmt(n, max=2){
    const v = Number(n);
    if(!Number.isFinite(v)) return '0';
    return v.toLocaleString('tr-TR', { maximumFractionDigits: max });
  }

  // Boş ise null dönen temizleyici (K/Z için kullan)
  function cleanNull(v){
    if(v === null || v === undefined) return null;
    let s = String(v).trim();
    if(!s || s === '-' || s === '0,00' || s.includes('#')) return null;

    // (1.234,56) -> negatif
    let negative = false;
    if(s.startsWith('(') && s.endsWith(')')){ negative = true; s = s.slice(1,-1); }

    try{
      s = s
        .replace(/TL|₺|\$|USD|€|EUR|£|GBP/gi,'')
        .replace(/%/g,'')
        .replace(/\s+/g,'')
        .replace(/\./g,'')       // binlik
        .replace(',', '.')       // ondalık
        .replace(/[^\d.-]/g,'');

      if(s.startsWith('-')){ negative = !negative; s = s.slice(1); }

      const num = parseFloat(s);
      if(Number.isFinite(num) && Math.abs(num) <= 1e12){
        return negative ? -num : num;
      }
      return null;
    }catch(e){ return null; }
  }

  // Boşsa 0 dönen temizleyici (tutar, fiyat vb. için)
  function clean0(v){
    const n = cleanNull(v);
    return n === null ? 0 : n;
  }

  function safeDailyPct(gKZ, tutar){
    const g = Number(gKZ), t = Number(tutar);
    if(!Number.isFinite(g) || !Number.isFinite(t) || t <= 0) return 0;
    const prev = t - g;
    if(!Number.isFinite(prev) || Math.abs(prev) < 1) return 0;
    let pct = (g / prev) * 100;
    if(!Number.isFinite(pct) || Math.abs(pct) > 500) return 0;
    return pct;
  }

  function getDaysBetween(dateStr) {
    if (!dateStr || dateStr.length < 5) return "-";
    try {
      const parts = dateStr.split('.');
      const d = new Date(parts[2], parts[1]-1, parts[0]);
      const diff = Math.floor((new Date() - d) / (1000 * 60 * 60 * 24));
      return diff >= 0 ? diff + " Gün" : "-";
    } catch(e) { return "-"; }
  }

  /* ==== K/Z TÜRETME: sadece NULL ise doldur ==== */
  function deriveKZ(item){
    const adet = Number(item.adet) || 0;
    const fiyat = Number(item.fiyat) || 0;

    // tKZ: yoksa türet
    if(item.tKZ === null){
      item.tKZ = (Number(item.tutar)||0) - (Number(item.yatirim)||0);
    }

    // g/h/aKZ: sadece NULL ise türet (0 ise olduğu gibi bırak)
    if(item.gKZ === null && adet > 0 && Number.isFinite(item.oncekiKapanis)){
      item.gKZ = adet * (fiyat - Number(item.oncekiKapanis));
    }
    if(item.hKZ === null && adet > 0 && Number.isFinite(item.haftaKapanis)){
      item.hKZ = adet * (fiyat - Number(item.haftaKapanis));
    }
    if(item.aKZ === null && adet > 0 && Number.isFinite(item.ayKapanis)){
      item.aKZ = adet * (fiyat - Number(item.ayKapanis));
    }
    // Son güvenlik: null kalanları 0 yap (gösterim/sum için)
    if(item.gKZ === null) item.gKZ = 0;
    if(item.hKZ === null) item.hKZ = 0;
    if(item.aKZ === null) item.aKZ = 0;
    if(item.tKZ === null) item.tKZ = 0;

    return item;
  }

  /* ============== FETCH ================= */
  async function fetchWithFallback(url, options = {}){
    try{
      const res = await fetch(url, { cache: "no-store", ...options });
      if(res.ok) return res;
      throw new Error(`HTTP ${res.status}`);
    }catch(e){
      const viaProxy = PROXY + encodeURIComponent(url);
      const res2 = await fetch(viaProxy, { cache: "no-store", ...options });
      if(!res2.ok) throw new Error(`Proxy HTTP ${res2.status}`);
      return res2;
    }
  }

  async function fetchData(){
    showLoading(true);
    if(currentFetch) currentFetch.abort();
    currentFetch = new AbortController();

    try{
      const res = await fetchWithFallback(SHEET_CSV_URL, { signal: currentFetch.signal });
      const text = await res.text();

      Papa.parse(text, {
        header: true,
        delimiter: ',',
        quoteChar: '"',
        escapeChar: '"',
        skipEmptyLines: true,
        dynamicTyping: false,
        transformHeader: normalizeHeader,
        beforeFirstChunk: (chunk) => chunk.replace(/^\uFEFF?/, '').trim(),
        complete: (result)=>{
          const rows = (result.data || []);
          buildDataFromRows(rows);
          setLastUpdated();
        }
      });

    }catch(err){
      if(err.name !== 'AbortError'){
        console.error('Veri alınamadı:', err);
      }
    }finally{
      showLoading(false);
      currentFetch = null;
    }
  }

  /* ============== CSV → DATA ================= */
  function buildDataFromRows(rows){
    // haritalama
    globalData = rows.map(r=>{
      const item = {
        ad: (r['varlik'] || r['varlık'] || '').toString().trim(),
        tur: (r['tur'] || r['tür'] || 'Diğer').toString().trim(),
        alisTarihi: r['alistarihi'] || r['alıştarihi'] || '',
        vade: r['vadetarihi'] || '',
        adet: clean0(r['adet']),
        aFiyat: clean0(r['alisfiyati'] || r['alışfiyatı']),
        yatirim: clean0(r['yatirimtutari'] || r['yatırımtutarı']),
        fiyat: clean0(r['guncelfiyat'] || r['güncelfiyat']),
        tutar: clean0(r['gunceltutar'] || r['günceltutar']),

        // K/Z — CSV değeri boşsa null, doluysa sayı
        gKZ: cleanNull(r['gkz']),
        hKZ: cleanNull(r['hkz']),
        aKZ: cleanNull(r['akz']),
        tKZ: cleanNull(r['tkz']),

        // Kapanışlar — türetmede kullanılabilir
        oncekiKapanis: clean0(r['oncekikapanis'] || r['öncekikapanis']),
        haftaKapanis: clean0(r['haftakapanis'] || r['haftakapanış']),
        ayKapanis: clean0(r['aykapanis'] || r['aykapanış'])
      };
      return deriveKZ(item);
    });

    renderAll();
  }

  /* ============== RENDER ================= */
  function renderAll() {
    // Toplamlar ve gruplar
    const totals = { yatirim:0, tutar:0, tKZ:0, gKZ:0, hKZ:0, aKZ:0 };
    const groups = {};
    globalData.forEach(item => {
      if (!groups[item.tur]) groups[item.tur] = { yatirim:0, tutar:0, tKZ:0, gKZ:0, hKZ:0, aKZ:0 };
      Object.keys(totals).forEach(key => {
        const v = Number(item[key]) || 0;
        groups[item.tur][key] += v;
        totals[key] += v;
      });
    });

    renderSummaries(totals, groups);
    renderTypeTabs(Object.keys(groups));
    renderTicker();
    renderMarketRows();
    renderPerformance();
    updateChart(groups);
  }

  function renderSummaries(totals, groups) {
    const summaryEl = document.getElementById("summaryGrid");
    const keys = [
      {id:'yatirim', l:'Yatırım'},
      {id:'tutar', l:'Portföy'},
      {id:'tKZ', l:'Toplam K/Z'},
      {id:'gKZ', l:'Günlük K/Z'},
      {id:'hKZ', l:'Haftalık K/Z'},
      {id:'aKZ', l:'Aylık K/Z'}
    ];

    summaryEl.innerHTML = keys.map(k => {
      const val = totals[k.id], isKZ = k.id.includes('KZ');
      const cardStatus = isKZ ? (val >= 0 ? 'up-card' : 'down-card') : '';
      const color = isKZ ? (val >= 0 ? 'up' : 'down') : '';
      const sortedTur = Object.keys(groups).sort((a,b) => groups[b][k.id] - groups[a][k.id]);
      let distHtml = sortedTur.map(t => `
        <div class="dist-row" onclick="event.stopPropagation(); showDetails('${t.replace(/'/g,"\\'")}')">
          <span>${t}</span>
          <span class="${groups[t][k.id] >= 0 ? 'up':'down'}">${fmt(groups[t][k.id])} ₺</span>
        </div>`).join('');
      return `
        <div class="card ${cardStatus}" onclick="toggleCard(this)">
          <span>${k.l}</span>
          <div class="value ${color}">${fmt(val)} ₺</div>
          <div class="dist-container">${distHtml}</div>
        </div>`;
    }).join('');
  }

  function renderTypeTabs(types){
    const tabs = document.getElementById('typeTabs');
    tabs.innerHTML = types.map((t)=>`<button class="type-tab" data-t="${t}">${t}</button>`).join('');
    tabs.querySelectorAll('.type-tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.querySelectorAll('.type-tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        showDetails(btn.dataset.t);
      });
    });
  }

  function renderPerformance() {
    // gKZ'e göre günlük % (gKZ null olsa bile deriveKZ sonrası 0 veya hesaplanmış olacak)
    const eligible = globalData.filter(d => d.tutar > 50);
    const sorted = eligible
      .map(d => ({ ...d, _pct: safeDailyPct(d.gKZ, d.tutar) }))
      .sort((a,b) => b._pct - a._pct);

    const bestBox = document.getElementById("bestPerf").querySelector('.up');
    const worstBox = document.getElementById("worstPerf").querySelector('.down');

    if(sorted.length > 0) {
      const best = sorted[0];
      const worst = sorted[sorted.length - 1];
      bestBox.textContent = `${best.ad}  (%${best._pct.toFixed(2)})`;
      worstBox.textContent = `${worst.ad}  (%${worst._pct.toFixed(2)})`;
    } else {
      bestBox.textContent = 'Veri yok';
      worstBox.textContent = 'Veri yok';
    }
  }

  function updateChart(groups) {
    const ctx = document.getElementById('allocationChart').getContext('2d');
    const labels = Object.keys(groups);
    const dataVals = labels.map(l => groups[l].tutar);
    const colors = labels.map(colorFor);

    if (allocationChart) allocationChart.destroy();
    allocationChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: dataVals,
          backgroundColor: colors,
          borderWidth: 2, borderColor: '#030508'
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } },
          tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.raw)} ₺` } }
        }
      }
    });
  }

  function renderMarketRows() {
    const targets = ["USDTRY", "EURTRY", "ALTIN/USD", "ALTIN/TL", "GRAMALTIN", "ENFLASYON", "MEVDUAT"];
    const rowsHtml = targets.map(name => {
      const n = normalizeText(name).replace(/\s+/g,'');
      const found = globalData.find(d => normalizeText(d.ad).replace(/\s+/g,'') === n);
      if(!found) return "";
      return `
        <div class="m-row">
          <span style="font-size:0.75rem; font-weight:700;">${name}</span>
          <span class="${Number(found.gKZ) >= 0 ? 'up' : 'down'}" style="font-weight:800; font-family:monospace;">
            ${fmt(found.fiyat)}
          </span>
        </div>`;
    }).join('');
    document.getElementById("marketRows").innerHTML = rowsHtml;
  }

  function renderTicker() {
    const ticker = document.getElementById("tickerContent");
    const meaningful = globalData.filter(a => a.tutar > 10);
    const moves = meaningful.map(a => {
      const y = safeDailyPct(a.gKZ, a.tutar);
      const dir = y >= 0 ? '▲' : '▼';
      return `<div class="ticker-item"><span>${a.ad}</span><span class="${y>=0?'up':'down'}">${dir} %${Math.abs(y).toFixed(2)}</span></div>`;
    });
    ticker.innerHTML = moves.length ? (moves.join('') + moves.join('') + moves.join('')) : '<div class="ticker-item">Veri yok</div>';
    ticker.style.animationDuration = `${Math.max(meaningful.length * 4, 25)}s`;
  }

  /* ============== DETAY ================= */
  function showDetails(tur) {
    const sect = document.getElementById("detailSection"), grid = document.getElementById("assetGrid");
    sect.style.display = "block";
    document.getElementById("detailTitle").textContent = `VARLIK ANALİZİ — ${tur}`;

    const items = globalData
      .filter(d => d.tur === tur)
      .sort((a,b) => b.tutar - a.tutar);

    const rows = items.map(a => `
      <div class="asset-item">
        <div class="asset-main" onclick="toggleAsset(this)">
          <div style="font-weight:700; font-size:0.8rem; flex:1">${a.ad}</div>
          <div style="text-align:right; display:flex; gap:18px; align-items:center;">
            <div class="up" style="font-weight:800; font-size:0.85rem; width:110px; text-align:right">${fmt(a.tutar)} ₺</div>
            <div class="${a.tKZ>=0?'up':'down'}" style="width:90px">${fmt(a.tKZ)} ₺</div>
            <div class="${a.gKZ>=0?'up':'down'}" style="width:90px">${fmt(a.gKZ)} ₺</div>
            <div class="${a.hKZ>=0?'up':'down'}" style="width:90px">${fmt(a.hKZ)} ₺</div>
            <div class="${a.aKZ>=0?'up':'down'}" style="width:90px">${fmt(a.aKZ)} ₺</div>
          </div>
        </div>
        <div class="asset-expand">
          <div class="det-box"><span class="det-lbl">Adet</span><span class="det-val">${fmt(a.adet)}</span></div>
          <div class="det-box"><span class="det-lbl">Alış Fiyatı</span><span class="det-val">${fmt(a.aFiyat)}</span></div>
          <div class="det-box"><span class="det-lbl">Yatırım</span><span class="det-val">${fmt(a.yatirim)} ₺</span></div>
          <div class="det-box"><span class="det-lbl">Süre</span><span class="det-val">${getDaysBetween(a.alisTarihi)}</span></div>
          <div class="det-box"><span class="det-lbl">Günlük %</span><span class="det-val ${safeDailyPct(a.gKZ,a.tutar)>=0?'up':'down'}">%${safeDailyPct(a.gKZ,a.tutar).toFixed(2)}</span></div>
          <div class="det-box"><span class="det-lbl">Vade</span><span class="det-val">${a.vade || '-'}</span></div>
        </div>
      </div>`).join('');

    grid.innerHTML = rows;
    sect.scrollIntoView({ behavior: 'smooth' });
  }

  function toggleCard(el) {
    const active = el.classList.contains('active');
    document.querySelectorAll('.card').forEach(c => { c.classList.remove('active'); c.style.zIndex = "1"; });
    if (!active) { el.classList.add('active'); el.style.zIndex = "999"; }
  }
  function toggleAsset(el) {
    const exp = el.parentElement.querySelector('.asset-expand');
    const open = exp.style.display === 'grid';
    document.querySelectorAll('.asset-expand').forEach(d => d.style.display = 'none');
    exp.style.display = open ? 'none' : 'grid';
  }
  function closeAll() {
    document.getElementById('detailSection').style.display = 'none';
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
  }

  // Başlat
  fetchData();
  setInterval(() => { fetchData(); }, 300000);
</script>
</body>
</html>
