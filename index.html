
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Portföy Terminali</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#030508; --card-bg:rgba(16,20,29,0.95);
      --accent:#00ff9d; --red:#ff3b5c; --text:#ffffff; --text-muted:#94a3b8; --border:rgba(255,255,255,0.1);
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:12px;}
    .container{max-width:1200px;margin:0 auto;}
    .notification-container{position:fixed;top:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;}
    .notification{background:var(--card-bg);border-left:4px solid var(--accent);padding:12px 20px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.3);min-width:300px;animation:slideInRight 0.3s;}
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}
    #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99998;align-items:center;justify-content:center;flex-direction:column;}
    .spinner{width:50px;height:50px;border:3px solid var(--accent);border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .header-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:15px;}
    .header-controls h1{margin:0;font-size:clamp(18px,3.5vw,24px);flex:0 0 auto;}
    .header-right{display:flex;align-items:center;gap:8px;margin-left:auto;}
    .control-btn{background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);cursor:pointer;font-weight:600;}
    .filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
    .filter-select,.filter-input{background:var(--card-bg);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:8px;min-width:200px;}
    .perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;}
    @media (max-width:768px){.perf-grid{grid-template-columns:1fr;}}
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:20px;}
    .card{background:var(--card-bg);padding:15px;border-radius:12px;border:1px solid var(--border);cursor:default;}
    .up{color:var(--accent);} .down{color:var(--red);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right;}
    th{text-align:left;}
    #lastUpdated{color:var(--text-muted);font-size:12px;}
    @media (prefers-reduced-motion: reduce){
      .notification{animation:none;}
      .spinner{animation:none;}
    }
  </style>
</head>
<body>

<div class="notification-container" id="notificationContainer" aria-live="polite"></div>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div style="color:var(--accent);">Yükleniyor...</div>
</div>

<div class="container">
  <div class="header-controls">
    <h1>Elite Portföy Terminali</h1>
    <div id="lastUpdated"></div>
    <div class="header-right">
      <input type="file" id="fileInput" accept=".csv" style="display:none" />
      <button class="control-btn" id="uploadBtn" title="Yerel CSV yükle"><i class="fa-solid fa-file-arrow-up"></i> CSV Yükle</button>
      <button class="control-btn" id="refreshBtn"><i class="fas fa-sync"></i> Yenile</button>
    </div>
  </div>

  <div class="filter-bar">
    <input type="text" id="searchInput" class="filter-input" placeholder="Varlık veya tür ara..."/>
    <button class="control-btn" id="clearBtn"><i class="fas fa-times"></i> Temizle</button>
  </div>

  <div class="perf-grid">
    <div id="bestPerf" style="background:var(--card-bg); padding:12px; border-radius:8px;">En İyi: yükleniyor...</div>
    <div id="worstPerf" style="background:var(--card-bg); padding:12px; border-radius:8px;">En Kötü: yükleniyor...</div>
  </div>

  <div id="summaryGrid" class="summary-grid"></div>

  <div style="background:var(--card-bg); padding:15px; border-radius:12px; margin-bottom:15px;">
    <canvas id="allocationChart" height="220"></canvas>
  </div>

  <div id="filterResultsSection" style="display:none; background:var(--card-bg); padding:15px; border-radius:12px;">
    <h3>Filtre Sonuçları</h3>
    <div id="filterResultsGrid"></div>
  </div>
</div>

<script>
/* ────────────────────────────────────────────────
   CONFIG
──────────────────────────────────────────────── */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
const PROXY = "https://corsproxy.io/?";

let globalData = [];
let allocationChart = null;
let currentFetch = null;
let cleanAnomalies = 0;

/* ────────────────────────────────────────────────
   UTILS
──────────────────────────────────────────────── */
const palette = ['#00ff9d','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#22d3ee','#84cc16','#d946ef','#f97316','#06b6d4'];
const colorMap = new Map();
function colorFor(label){
  if(!colorMap.has(label)) colorMap.set(label, palette[colorMap.size % palette.length]);
  return colorMap.get(label);
}

function normalizeHeader(h) {
  if (!h) return '';
  let s = String(h).trim().toLowerCase();
  const map = { 'ı':'i','ğ':'g','ü':'u','ş':'s','ö':'o','ç':'c','İ':'i','Ğ':'g','Ü':'u','Ş':'s','Ö':'o','Ç':'c' };
  s = s.replace(/[ığüşöçİĞÜŞÖÇ]/g, c => map[c] || c);
  s = s.replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
  return s;
}

function clean(v){
  if(v === null || v === undefined) return 0;
  let s = String(v).trim();
  if(!s || s === '-' || s === '0,00' || s.includes('#')) return 0;

  // Parantezli negatif
  let negative = false;
  if(s.startsWith('(') && s.endsWith(')')){
    negative = true;
    s = s.slice(1,-1);
  }

  try{
    s = s
      .replace(/TL|₺|\$|USD|€|EUR|£|GBP/gi,'')
      .replace(/%/g,'')
      .replace(/\s+/g,'')
      .replace(/\./g,'')       // binlik noktaları
      .replace(',', '.')       // ondalık virgül
      .replace(/[^\d.-]/g,'');

    if(s.startsWith('-')){ negative = !negative; s = s.slice(1); }

    const num = parseFloat(s);
    if(Number.isFinite(num) && Math.abs(num) <= 1e12){
      return negative ? -num : num;
    }
    cleanAnomalies++;
    console.warn('clean() anomalisi:', v, '→', s);
    return 0;
  }catch(e){
    cleanAnomalies++;
    console.error('clean() hatası:', v, e);
    return 0;
  }
}

function safeDailyPct(gKZ, tutar){
  const g = Number(gKZ), t = Number(tutar);
  if(!Number.isFinite(g) || !Number.isFinite(t) || t <= 0) return 0;
  const prev = t - g;
  if(!Number.isFinite(prev) || Math.abs(prev) < 1) return 0;
  let pct = (g / prev) * 100;
  if(!Number.isFinite(pct) || Math.abs(pct) > 500) return 0;
  return pct;
}

function showNotification(msg, type='info'){
  const div = document.createElement('div');
  div.className = `notification ${type}`;
  div.textContent = msg;
  document.getElementById('notificationContainer').appendChild(div);
  setTimeout(()=>div.remove(), 5000);
}

function setLastUpdated(dateObj = new Date()){
  const el = document.getElementById('lastUpdated');
  el.textContent = `Son güncelleme: ${dateObj.toLocaleString('tr-TR')}`;
}

function debounce(fn, ms=250){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ────────────────────────────────────────────────
   FETCH (Failover + AbortController)
──────────────────────────────────────────────── */
async function fetchWithFallback(url, options={}){
  try{
    const res = await fetch(url, { cache: "no-store", ...options });
    if(res.ok) return res;
    throw new Error(`Birincil başarısız: HTTP ${res.status}`);
  }catch(e){
    const viaProxy = PROXY + encodeURIComponent(url);
    const res2 = await fetch(viaProxy, { cache: "no-store", ...options });
    if(!res2.ok) throw new Error(`Proxy başarısız: HTTP ${res2.status}`);
    return res2;
  }
}

async function fetchData(){
  document.getElementById('loadingOverlay').style.display = 'flex';
  if(currentFetch) currentFetch.abort();
  currentFetch = new AbortController();

  try{
    const res = await fetchWithFallback(SHEET_CSV_URL, { signal: currentFetch.signal });
    const text = await res.text();

    Papa.parse(text, {
      header: true,
      delimiter: ',',
      quoteChar: '"',
      escapeChar: '"',
      skipEmptyLines: true,
      dynamicTyping: false,
      transformHeader: (h) => normalizeHeader(h),
      beforeFirstChunk: (chunk) => chunk.replace(/^\uFEFF?/, '').trim(),
      complete: (result)=>{
        const rows = (result.data || []);
        buildDataFromRows(rows, 'uzak');
      }
    });

  }catch(err){
    if(err.name !== 'AbortError'){
      console.error(err);
      showNotification('Veri alınamadı: ' + err.message, 'error');
    }
  }finally{
    document.getElementById('loadingOverlay').style.display = 'none';
    currentFetch = null;
  }
}

/* ────────────────────────────────────────────────
   CSV -> DATA MAPPING (normalize edilmiş başlıklarla)
──────────────────────────────────────────────── */
function buildDataFromRows(rows, kaynak='uzak'){
  cleanAnomalies = 0;

  const mapped = rows.map(r=>{
    const item = {
      ad: (r['varlık'] || r['varlik'] || '').toString().trim(),
      tur: (r['tür'] || r['tur'] || 'Diğer').toString().trim(),
      alisTarihi: r['alıştarihi'] || r['alistarihi'] || '',
      vade: r['vadetarihi'] || '',
      adet: clean(r['adet']),
      aFiyat: clean(r['alışfiyatı'] || r['alisfiyati']),
      yatirim: clean(r['yatırımtutarı'] || r['yatirimtutari']),
      fiyat: clean(r['güncelfiyat'] || r['guncelfiyat']),
      tutar: clean(r['günceltutar'] || r['gunceltutar']),
      gKZ: clean(r['gkz']),
      hKZ: clean(r['hkz']),
      aKZ: clean(r['akz']),
      tKZ: clean(r['tkz']),
      faizOrani: clean(r['faizoranı'] || r['faizorani']),
      oncekiKapanis: clean(r['öncekikapanış'] || r['oncekikapanis']),
      haftaKapanis: clean(r['haftakapanış'] || r['haftakapanis']),
      ayKapanis: clean(r['aykapanış'] || r['aykapanis'])
    };
    return item;
  });

  const zeros = [];
  mapped.forEach(x => { if (x.ad && !x.tutar) zeros.push({ ad:x.ad, fiyat:x.fiyat, tutar:x.tutar }); });
  if (zeros.length) console.warn('Tutarı 0 kalan ilk kayıtlar:', zeros.slice(0,10));

  globalData = mapped.filter(d => d.ad && d.tutar > 0);

  const totalRows = rows.length;
  const kept = globalData.length;
  console.log(`Kaynak: ${kaynak} | CSV satır: ${totalRows} | işlenen: ${kept} | clean anomalileri: ${cleanAnomalies}`);

  renderAll();
  setLastUpdated();
  showNotification(`Yükleme tamamlandı: ${kept}/${totalRows} satır`, kept ? 'success' : 'warn');
}

/* ────────────────────────────────────────────────
   RENDER
──────────────────────────────────────────────── */
function renderAll(){
  const summaryEl = document.getElementById('summaryGrid');
  const bestEl = document.getElementById('bestPerf');
  const worstEl = document.getElementById('worstPerf');

  if(!globalData.length){
    summaryEl.innerHTML = '<p style="text-align:center; padding:30px;">Veri bulunamadı. Olası nedenler: CSV başlıkları beklenenden farklı, tüm “Güncel Tutar” değerleri 0 görünüyor veya veri çekilemedi.</p>';
    bestEl.textContent = 'En İyi: veri yok';
    worstEl.textContent = 'En Kötü: veri yok';
    if(allocationChart){ allocationChart.destroy(); allocationChart = null; }
    return;
  }

  // Toplam portföy
  const totalTutar = globalData.reduce((s,d)=> s + d.tutar, 0);
  summaryEl.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `<strong>Toplam Portföy:</strong><br>${totalTutar.toLocaleString('tr-TR')} ₺`;
  summaryEl.appendChild(card);

  // En iyi / en kötü (günlük %)
  const sorted = [...globalData].sort((a,b)=> safeDailyPct(b.gKZ,b.tutar) - safeDailyPct(a.gKZ,a.tutar));
  const best = sorted[0];
  const worst = sorted[sorted.length - 1];

  function setPerf(el, label, item, cls){
    const wrap = document.createElement('div');
    const t1 = document.createElement('div'); t1.textContent = `${label}: ${item.ad}`;
    const t2 = document.createElement('div');
    const pct = safeDailyPct(item.gKZ, item.tutar).toFixed(2) + '%';
    t2.textContent = pct; t2.className = cls;
    wrap.appendChild(t1); wrap.appendChild(t2);
    el.innerHTML = ''; el.appendChild(wrap);
  }
  setPerf(bestEl, 'En İyi', best, 'up');
  setPerf(worstEl, 'En Kötü', worst, 'down');

  // Kategori bazlı dağılım
  const groups = {};
  globalData.forEach(d => { groups[d.tur] = (groups[d.tur] || 0) + d.tutar; });
  const labels = Object.keys(groups);
  const data = labels.map(l => groups[l]);
  const colors = labels.map(colorFor);

  if(allocationChart) allocationChart.destroy();
  const ctx = document.getElementById('allocationChart');
  allocationChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins:{
        legend:{ position:'bottom', labels:{ color:'#e5e7eb' }},
        tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${Number(c.raw).toLocaleString('tr-TR')} ₺` } }
      }
    }
  });
}

/* ────────────────────────────────────────────────
   FİLTRELEME (XSS güvenli DOM + Debounce)
──────────────────────────────────────────────── */
function createCell(tag, text, className){
  const el = document.createElement(tag);
  el.textContent = text;
  if(className) el.className = className;
  return el;
}

function renderFilteredTable(rows){
  const tbl = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  ['Varlık','Tür','Tutar','Günlük %'].forEach(h => trh.appendChild(createCell('th', h)));
  thead.appendChild(trh); tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(d=>{
    const tr = document.createElement('tr');
    const pct = safeDailyPct(d.gKZ, d.tutar);
    tr.appendChild(createCell('td', d.ad));
    tr.appendChild(createCell('td', d.tur));
    tr.appendChild(createCell('td', d.tutar.toLocaleString('tr-TR')));
    tr.appendChild(createCell('td', `${pct.toFixed(2)}%`, pct >= 0 ? 'up':'down'));
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  const container = document.getElementById('filterResultsGrid');
  container.innerHTML = '';
  container.appendChild(tbl);
}

function filterAssets(){
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  if(!q){
    document.getElementById('filterResultsSection').style.display = 'none';
    return;
  }
  const filtered = globalData.filter(d =>
    d.ad.toLowerCase().includes(q) || d.tur.toLowerCase().includes(q)
  );
  renderFilteredTable(filtered);
  document.getElementById('filterResultsSection').style.display = 'block';
}

function clearFilters(){
  const input = document.getElementById('searchInput');
  input.value = '';
  sessionStorage.removeItem('search');
  document.getElementById('filterResultsSection').style.display = 'none';
}

/* ────────────────────────────────────────────────
   YEREL CSV YÜKLEME (Dosyadan)
──────────────────────────────────────────────── */
function loadFromFile(file){
  if(!file) return;
  document.getElementById('loadingOverlay').style.display = 'flex';
  Papa.parse(file, {
    header: true,
    delimiter: ',',
    quoteChar: '"',
    escapeChar: '"',
    skipEmptyLines: true,
    dynamicTyping: false,
    transformHeader: (h) => normalizeHeader(h),
    beforeFirstChunk: (chunk) => chunk.replace(/^\uFEFF?/, '').trim(),
    complete: (result)=>{
      const rows = (result.data || []);
      buildDataFromRows(rows, 'yerel');
      document.getElementById('loadingOverlay').style.display = 'none';
    },
    error: (err)=>{
      document.getElementById('loadingOverlay').style.display = 'none';
      showNotification('CSV okunamadı: ' + err.message, 'error');
    }
  });
}

/* ────────────────────────────────────────────────
   BAŞLATMA
──────────────────────────────────────────────── */
window.addEventListener('DOMContentLoaded', ()=>{
  const refreshBtn = document.getElementById('refreshBtn');
  const clearBtn = document.getElementById('clearBtn');
  const searchInput = document.getElementById('searchInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');

  // Debounce’lu arama + kalıcılık
  const filterAssetsDebounced = debounce(filterAssets, 250);
  searchInput.addEventListener('input', (e)=>{
    sessionStorage.setItem('search', e.target.value);
    filterAssetsDebounced();
  });
  searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ clearFilters(); }});

  // Önceki aramayı geri yükle
  const saved = sessionStorage.getItem('search');
  if(saved){ searchInput.value = saved; }

  // Yenile (uzak kaynaktan çek)
  refreshBtn.addEventListener('click', ()=> fetchData());

  // Temizle
  clearBtn.addEventListener('click', ()=> clearFilters());

  // Yerel CSV yükle
  uploadBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=> {
    const file = e.target.files?.[0];
    if(file) loadFromFile(file);
  });

  // Sayfa yüklenince çek
  fetchData();

  // 5 dakikada bir otomatik (arama kutusu focus’tayken ertele)
  setInterval(()=>{
    if(document.activeElement === searchInput) return;
    fetchData();
  }, 300000);
});
</script>
</body>
</html>
``
