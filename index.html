<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Elite Portföy Terminali v5.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030508; --card-bg: rgba(16, 20, 29, 0.95);
      --accent: #00ff9d; --red: #ff3b5c; --text: #ffffff;
      --text-muted: #94a3b8; --border: rgba(255, 255, 255, 0.1);
    }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .section-title { font-size: 0.6rem; font-weight: 800; color: var(--text-muted); margin: 15px 0 8px 5px; text-transform: uppercase; letter-spacing: 1px; }
    .grid-top, .grid-sub { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
    .card { background: var(--card-bg); padding: 12px; border-radius: 14px; border: 1px solid var(--border); position: relative; }
    .card span { color: var(--text-muted); font-size: 0.55rem; font-weight: 700; display: block; margin-bottom: 4px; }
    .card .value { font-size: 0.85rem; font-weight: 800; white-space: nowrap; }
    .main-card { border-top: 3px solid #334155; }
    .kz-card { border-left: 3px solid #334155; }
    .up-border { border-color: var(--accent) !important; }
    .down-border { border-color: var(--red) !important; }
    .up { color: var(--accent); } .down { color: var(--red); }
    .content-block { background: var(--card-bg); border-radius: 18px; border: 1px solid var(--border); padding: 15px; margin-top: 15px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.65rem; font-weight: 800; color: var(--accent); }
    .chart-select { background: #11151c; color: var(--accent); border: 1px solid var(--border); border-radius: 5px; padding: 2px 5px; cursor: pointer; font-size: 0.6rem; }
    .m-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .m-item { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

<div class="container">
  <div class="section-title">Ana Portföy Özeti</div>
  <div class="grid-top" id="topCards"></div>

  <div class="section-title">Kısa Vade Performans</div>
  <div class="grid-sub" id="shortKZ"></div>

  <div class="section-title">Uzun Vade Performans</div>
  <div class="grid-sub" id="longKZ"></div>

  <div class="content-block">
    <div class="header-row">
      <div>VARLIK DAĞILIMI</div>
      <select class="chart-select" id="chartType" onchange="renderAll()">
        <option value="doughnut">Halka</option>
        <option value="bar">Çubuk</option>
        <option value="pie">Pasta</option>
      </select>
    </div>
    <div style="height: 200px;"><canvas id="allocationChart"></canvas></div>
  </div>

  <div class="content-block">
    <div class="header-row">PİYASA GÖSTERGELERİ</div>
    <div class="m-grid" id="marketGrid"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
  // Hata Fixlendi: Parametre ayırıcı '?' yerine '&' kullanıldı
  const portfoyCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";
  const macroCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=1018386005&single=true&output=csv";
  
  let pData = [], mData = [], myChart = null;

  function clean(v) {
    if (!v || v === "" || v.toString().includes('#N/A')) return 0;
    let s = v.toString().replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]+/g, '');
    return parseFloat(s) || 0;
  }

  async function init() {
    // Cache busting parametresi URL sonuna "&" ile eklendi
    const cb = "&cache_bust=" + new Date().getTime();
    
    try {
      const [resP, resM] = await Promise.all([
        new Promise((resolve, reject) => Papa.parse(portfoyCsv + cb, { download: true, complete: resolve, error: reject })),
        new Promise((resolve, reject) => Papa.parse(macroCsv + cb, { download: true, complete: resolve, error: reject }))
      ]);
      
      pData = resP.data.slice(1).map(r => ({
        tur: r[1], yatirim: clean(r[6]), tutar: clean(r[8]), 
        gKZ: clean(r[9]), hKZ: clean(r[10]), aKZ: clean(r[11]),
        kz3: clean(r[12]), kz6: clean(r[13]), kz1y: clean(r[14]), tKZ: clean(r[15])
      })).filter(d => d.tutar !== 0 || d.yatirim !== 0);

      mData = resM.data.slice(1).map(r => ({ k: r[0], v: r[1] })).filter(d => d.k);
      renderAll();
    } catch (err) {
      console.error("Veri yükleme hatası:", err);
    }
  }

  function renderAll() {
    const t = { y:0, p:0, tkz:0, g:0, h:0, a:0, k3:0, k6:0, k1y:0 };
    const groups = {};

    pData.forEach(d => {
      t.y += d.yatirim; t.p += d.tutar; t.tkz += d.tKZ;
      t.g += d.gKZ; t.h += d.hKZ; t.a += d.aKZ;
      t.k3 += d.kz3; t.k6 += d.kz6; t.k1y += d.kz1y;
      if(d.tur) groups[d.tur] = (groups[d.tur] || 0) + d.tutar;
    });

    document.getElementById("topCards").innerHTML = `
      <div class="card main-card"><span>Toplam Yatırım</span><div class="value">${t.y.toLocaleString('tr-TR')} ₺</div></div>
      <div class="card main-card"><span>Güncel Portföy</span><div class="value">${t.p.toLocaleString('tr-TR')} ₺</div></div>
      <div class="card main-card ${t.tkz>=0?'up-border':'down-border'}"><span>Toplam K/Z</span><div class="value ${t.tkz>=0?'up':'down'}">${t.tkz.toLocaleString('tr-TR')} ₺</div></div>
    `;

    const drawKZ = (label, val) => `
      <div class="card kz-card ${val>=0?'up-border':'down-border'}">
        <span>${label}</span>
        <div class="value ${val>=0?'up':'down'}">${val.toLocaleString('tr-TR')} ₺</div>
      </div>`;

    document.getElementById("shortKZ").innerHTML = drawKZ('Günlük K/Z', t.g) + drawKZ('Haftalık K/Z', t.h) + drawKZ('Aylık K/Z', t.a);
    document.getElementById("longKZ").innerHTML = drawKZ('3 Aylık K/Z', t.k3) + drawKZ('6 Aylık K/Z', t.k6) + drawKZ('1 Yıllık K/Z', t.k1y);

    document.getElementById("marketGrid").innerHTML = mData.map(d => `
      <div class="m-item">
        <span style="font-size:0.55rem; font-weight:700; color:var(--text-muted);">${d.k}</span>
        <span class="up" style="font-weight:800; font-family:monospace; font-size:0.75rem;">${clean(d.v).toLocaleString('tr-TR')}</span>
      </div>`).join('');
    
    const ctx = document.getElementById('allocationChart').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
      type: document.getElementById("chartType").value,
      data: { labels: Object.keys(groups), datasets: [{ data: Object.values(groups), backgroundColor: ['#00ff9d', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'], borderWidth:0 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'right', labels:{color:'#94a3b8', font:{size:9}} } } }
    });
  }

  init();
  setInterval(init, 300000);
</script>
</body>
</html>
