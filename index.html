<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>PortfÃ¶y Terminali Pro Max</title>
<style>
:root{
  --bg:#0b1220; --card:#111827; --line:#1f2937; --pos:#22c55e; --neg:#ef4444; --accent:#3b82f6;
  --text:#e5e7eb; --muted:rgba(229,231,235,.7);
}
*{ box-sizing: border-box; }
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  overflow-x:hidden;
}
h2{ margin:14px 16px 6px; font-size:11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }

/* Ticker */
.ticker-wrap{
  width:100%; overflow:hidden; background:#1a2234; border-bottom:2px solid var(--line);
  padding:12px 0; display:flex;
}
.ticker{ display:flex; white-space:nowrap; animation: ticker-move 40s linear infinite; will-change: transform; }
.ticker-item{
  display:flex; align-items:center; padding:0 25px; font-size:16px; font-weight:800;
  border-right:1px solid rgba(255,255,255,0.1);
}
@keyframes ticker-move { 0%{ transform: translateX(0); } 100%{ transform: translateX(-50%); } }
@media (prefers-reduced-motion: reduce){
  .ticker{ animation-duration: 120s; }
}

/* Header */
.header-section{
  position: sticky; top: 0; z-index: 100;
  background: rgba(11, 18, 32, 0.95); backdrop-filter: blur(15px);
  border-bottom: 1px solid var(--line); padding: 10px 10px env(safe-area-inset-right) 10px;
}

/* Header top row */
.header-top{
  display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 0 6px 6px;
}
.badge{
  display:inline-flex; align-items:center; gap:6px; font-size:11px; color:var(--muted);
  border:1px solid var(--line); padding:4px 8px; border-radius: 999px;
}

/* Grids */
.grid-summary{ display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:12px; }
.grid-types{ display:grid; grid-template-columns: repeat(auto-fill, minmax(118px, 1fr)); gap:8px; }
.grid-periods{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; padding: 0 10px; }
@media (min-width: 560px){
  .grid-periods{ grid-template-columns: repeat(3, 1fr); }
}

/* Cards */
.card{
  background: linear-gradient(145deg, var(--card), #161e2e); border-radius: 12px; padding: 10px;
  border: 1px solid var(--line); display: flex; flex-direction: column; transition: 0.2s ease;
}
.card:focus-visible{
  outline: 3px solid var(--accent); outline-offset: 2px;
}
.big{ font-size:14px; font-weight:700; margin-top:2px; }
.small{ font-size:9px; font-weight:700; opacity:.8; text-transform: uppercase; }
.pos{ color: var(--pos); }
.neg{ color: var(--neg); }

/* Type cards */
.type-card{
  cursor: pointer; opacity: 0.9; text-align: center; border: 1px solid var(--line);
  user-select:none; position:relative; overflow:hidden;
}
.type-card:hover{ transform: translateY(-1px); }
.type-card.active{
  border-color: var(--accent); opacity:1; background: rgba(59, 130, 246, 0.12);
  box-shadow: 0 0 12px rgba(59,130,246,0.2);
}
.type-color-dot{
  position:absolute; top:8px; right:8px; width:8px; height:8px; border-radius:50%;
  box-shadow: 0 0 6px rgba(255,255,255,.2);
}

/* Controls & list */
.controls{
  display:flex; gap:8px; align-items:center; padding: 0 10px; flex-wrap: wrap; margin-bottom: 8px;
}
.controls .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.select{
  background: var(--card); border:1px solid var(--line); color:var(--text);
  border-radius:8px; padding: 7px 10px; font-size:12px;
}
#search{
  width: min(420px, 100%); padding: 9px 10px; background: var(--card);
  border: 1px solid var(--line); border-radius: 8px; color: #e5e7eb;
}
.detail-item{
  background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 10px 12px;
  margin-bottom: 8px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
  cursor: pointer;
}
.detail-item:hover{ outline:1px solid rgba(59,130,246,.35); }
.detail-info div:first-child{ font-weight: 800; font-size: 13px; color: #fff; display:flex; align-items:center; gap:6px; }
.detail-info div:last-child{ font-size: 10px; color: var(--muted); }
.detail-values{ text-align: right; }
.detail-val{ font-weight: 700; font-size: 13px; }
.detail-perc{ font-size: 11px; font-weight: 700; }
.list-alert-badge{
  display:inline-flex; align-items:center; gap:4px; font-size:10px; padding:2px 6px; border-radius:999px;
  color:#fecaca; background: rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35);
}

/* Sparkline */
.spark{ width: 90px; height: 26px; display:inline-block; margin-left: 6px; opacity: .9; vertical-align: -6px; }
.spark path{ fill:none; stroke-width:1.8; }

/* Loader & alerts */
#loader{
  position: fixed; inset:0; background:var(--bg); z-index:999; display:flex; flex-direction:column;
  justify-content:center; align-items:center; font-weight:bold; color:var(--accent); gap:10px;
}
.inline-alert{
  margin: 10px; padding: 8px 10px; border-radius: 8px; background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.35);
  color:#fecaca; font-size:12px;
}

/* MODAL (Detay KartÄ±) */
.modal-backdrop{
  position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index: 1000;
}
.modal-backdrop.show{ display:flex; }
.modal-card{
  background: linear-gradient(145deg, var(--card), #162033);
  border:1px solid var(--line); border-radius: 14px; width: min(780px, 94vw); max-height: 90vh;
  overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,.45);
}
.modal-head{
  display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom:1px solid var(--line);
}
.modal-title{
  display:flex; align-items:center; gap:10px; font-weight:800;
}
.modal-chip{
  font-size:11px; color:var(--muted); border:1px solid var(--line); padding:2px 8px; border-radius:999px;
}
.modal-alert-badge{
  font-size:11px; color:#fecaca; background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35);
  padding:2px 8px; border-radius:999px;
}
.modal-close{
  background: transparent; color: var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 10px; cursor:pointer;
}
.modal-section{ padding: 12px 14px; display:grid; gap:10px; }

/* Trend area */
.trend-toolbar{
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.pills{ display:inline-flex; gap:6px; }
.pill{
  border:1px solid var(--line); background: var(--card); color: var(--text);
  padding:4px 10px; font-size:12px; border-radius:999px; cursor:pointer; user-select:none;
}
.pill.active{ border-color: var(--accent); background: rgba(59,130,246,.15); }
.trend-wrap{ background: #0f1627; border:1px solid var(--line); border-radius:10px; padding:8px; }

/* Form */
.form-grid{
  display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
}
@media (max-width: 620px){
  .form-grid{ grid-template-columns: 1fr; }
}
.input{
  width:100%; background: var(--card); border:1px solid var(--line); border-radius:8px; color:var(--text); padding:8px 10px;
}
.form-actions{ display:flex; gap:8px; justify-content:flex-end; }
.btn{
  background: var(--card); border:1px solid var(--line); color:var(--text); border-radius:8px; padding:8px 12px; cursor:pointer;
}
.btn.primary{ border-color: var(--accent); background: rgba(59,130,246,.15); }
.btn.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); color:#fecaca; }
.help{ font-size:11px; color: var(--muted); }
.kv{ display:grid; grid-template-columns: 120px 1fr; gap:6px; align-items:center; }
.kv .key{ font-size:12px; color: var(--muted); }
.kv .val{ font-weight:700; }

/* Table (GeÃ§miÅŸ getirisi) */
.table{
  width:100%; border-collapse: collapse; font-size:12px; background:#0f1627; border:1px solid var(--line); border-radius:10px; overflow:hidden;
}
.table th, .table td{ padding:8px 10px; border-bottom:1px solid var(--line); }
.table th{ text-align:left; color:var(--muted); font-weight:700; }
.table tr:last-child td{ border-bottom:none; }
.table td.val-pos{ color: var(--pos); font-weight:700; }
.table td.val-neg{ color: var(--neg); font-weight:700; }

/* Accessible focus */
button:focus-visible, .pill:focus-visible, .input:focus-visible{
  outline:2px solid var(--accent); outline-offset:2px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
<div id="loader" aria-live="polite">
  <div>Veriler Analiz Ediliyor...</div>
  <div style="font-size:12px; opacity:.7">LÃ¼tfen bekleyin</div>
</div>

<div class="ticker-wrap"><div class="ticker" id="ticker-content" aria-hidden="true"></div></div>

<div id="app">
  <div class="header-section">
    <div class="header-top">
      <div class="badge" id="status-badge">Durum: <span id="status-text">Ã‡evrimiÃ§i</span></div>
      <div class="badge">Son veri: <span id="last-updated">-</span></div>
    </div>

    <div class="grid-summary" id="summary" aria-label="Genel Ã¶zet"></div>
    <h2>ðŸ’¼ VarlÄ±k GruplarÄ±</h2>
    <div class="grid-types" id="types" role="tablist" aria-label="VarlÄ±k tÃ¼rleri"></div>
  </div>

  <div class="content-section" style="padding: 0 10px;">
    <h2>ðŸ“ˆ DÃ¶nemsel Performans</h2>
    <div id="periods" class="grid-periods" role="region" aria-label="DÃ¶nemsel performans kartlarÄ±"></div>

    <h2 id="detail-title">ðŸ“¦ ÃœrÃ¼n DetaylarÄ±</h2>

    <div class="controls">
      <div class="row" role="group" aria-label="SÄ±ralama">
        <label class="small" for="sort-by" style="opacity:.8">SÄ±rala:</label>
        <select id="sort-by" class="select" aria-label="SÄ±ralama Ã¶lÃ§Ã¼tÃ¼">
          <option value="kz">K/Z</option>
          <option value="guncel">GÃ¼ncel</option>
          <option value="maliyet">Maliyet</option>
          <option value="ad">Ad</option>
        </select>
        <select id="sort-dir" class="select" aria-label="SÄ±ralama yÃ¶nÃ¼">
          <option value="desc">Azalan</option>
          <option value="asc">Artan</option>
        </select>
      </div>
      <div class="row" style="margin-left:auto">
        <input type="text" id="search" placeholder="ÃœrÃ¼n ara..." aria-label="ÃœrÃ¼n ara" />
      </div>
    </div>

    <div id="detail-list" role="list" aria-label="ÃœrÃ¼n listesi"></div>

    <div id="inline-alert" class="inline-alert" style="display:none"></div>
  </div>
</div>

<!-- Modal (Detay KartÄ±) -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">
        <span id="modal-title">Detay</span>
        <span id="modal-type-chip" class="modal-chip"></span>
        <span id="modal-alert-badge" class="modal-alert-badge" style="display:none">UyarÄ±!</span>
      </div>
      <button class="modal-close" id="modal-close-btn" aria-label="Kapat">Kapat âœ•</button>
    </div>
    <div class="modal-section" id="modal-body">
      <!-- Dinamik iÃ§erik JS ile doldurulur -->
    </div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLPFVZn0j8Ygu914QDGRCGKsVy88gWjdk7DFi-jWiydmqYsdGUE4hEAb-R_IBzQmtFZwoMJFcN6rlD/pub?gid=1050165900&single=true&output=csv";

// Cache
const CACHE_KEY_DATA = "portfolio_cache_data_v1";
const CACHE_KEY_TIME = "portfolio_cache_time_v1";
// Alerts (Ã¼rÃ¼ne Ã¶zel eÅŸikler)
const ALERTS_KEY = "portfolio_alerts_v1";

let DATA = [];
let ACTIVE = "ALL";
let searchDebounceTimer = null;
let SORT_BY = "kz";   // kz | guncel | maliyet | ad
let SORT_DIR = "desc";// desc | asc

/* Utils */
const cleanStr = (s) => s ? s.toString().trim().replace(/\s+/g, ' ') : "";
function toNumber(v){
  if (v === null || v === undefined) return 0;
  let str = v.toString().trim()
    .replace(/[^\d,\.\-]/g, '')              // para simge/boÅŸluk temizle, iÅŸaretleri koru
    .replace(/\.(?=\d{3}(\D|$))/g, '')       // binlik noktalarÄ±nÄ± kaldÄ±r
    .replace(',', '.');                      // ondalÄ±k virgÃ¼l -> nokta
  const num = parseFloat(str);
  if (!Number.isFinite(num)) return 0;
  return Math.abs(num) === 0 ? 0 : num;      // -0 -> 0
}
const formatTRY = v => (isFinite(v) ? Math.round(v) : 0).toLocaleString('tr-TR') + " â‚º";
const sign = v => (v >= 0 ? '+' : '');
const formatPercentSigned = v => `${v >= 0 ? '+' : ''}${Math.abs(v).toFixed(1)}%`;
const nowStr = () => new Date().toLocaleString('tr-TR');

/* Type color (deterministic hash -> palette) */
const TYPE_PALETTE = [
  "#22c55e","#3b82f6","#a78bfa","#f59e0b","#ef4444","#06b6d4","#10b981","#f472b6","#f97316","#84cc16"
];
function typeColor(tur){
  const s = cleanStr(tur).toUpperCase();
  let h = 0; for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) & 0xffffffff;
  const idx = Math.abs(h) % TYPE_PALETTE.length;
  return TYPE_PALETTE[idx];
}

/* Alerts store */
function loadAlerts(){
  try{
    const raw = localStorage.getItem(ALERTS_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch{ return {}; }
}
function saveAlerts(obj){
  try{ localStorage.setItem(ALERTS_KEY, JSON.stringify(obj)); }catch{}
}
function getAlertFor(urun){
  const store = loadAlerts();
  return store[urun] || { guncel:null, kz:null, gunlukPct:null };
}
function setAlertFor(urun, alertObj){
  const store = loadAlerts();
  store[urun] = alertObj;
  saveAlerts(store);
}
function clearAlertFor(urun){
  const store = loadAlerts();
  delete store[urun];
  saveAlerts(store);
}

/* DOM helpers */
function setAlert(msg){
  const el = document.getElementById('inline-alert');
  if (!msg) { el.style.display='none'; el.textContent=''; return; }
  el.textContent = msg;
  el.style.display = '';
}
function setStatus(text, online=true){
  document.getElementById('status-text').textContent = text;
  document.getElementById('status-badge').style.borderColor = online ? "rgba(34,197,94,.5)" : "rgba(239,68,68,.5)";
}

/* Sparkline (list) */
function sparkline(values, width=90, height=26){
  const vals = values.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...vals, 0);
  const max = Math.max(...vals, 0);
  const span = (max - min) || 1;
  const step = (width - 6) / Math.max(vals.length - 1, 1); // padding 3px
  let d = "";
  vals.forEach((v, i) => {
    const x = 3 + i * step;
    const y = height - 3 - ((v - min) / span) * (height - 6);
    d += (i === 0 ? `M${x},${y}` : ` L${x},${y}`);
  });
  const last = vals[vals.length - 1] || 0;
  const stroke = last >= 0 ? "var(--pos)" : "var(--neg)";
  return `
    <svg class="spark" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" aria-hidden="true">
      <path d="${d}" stroke="${stroke}" fill="none" stroke-width="1.8"></path>
      <line x1="0" y1="${height-3}" x2="${width}" y2="${height-3}" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
    </svg>
  `;
}

/* Trend chart (modal) â€” 3 nokta: GÃ¼n, Hafta, Ay */
function trendLine3(values, labels, width=420, height=160){
  const vals = values.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...vals, 0);
  const max = Math.max(...vals, 0);
  const span = (max - min) || 1;
  const padding = {x:22, y:18};
  const innerW = width - padding.x*2;
  const innerH = height - padding.y*2;
  const step = innerW / Math.max(vals.length - 1, 1);
  let d = "";
  const points = [];
  vals.forEach((v, i) => {
    const x = padding.x + i * step;
    const y = padding.y + (innerH - ((v - min) / span) * innerH);
    points.push([x,y]);
    d += (i === 0 ? `M${x},${y}` : ` L${x},${y}`);
  });
  const axisY = padding.y + innerH;
  return `
    <svg viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" aria-label="Trend grafiÄŸi">
      <rect x="0" y="0" width="${width}" height="${height}" rx="8" ry="8" fill="#0f1627" />
      <line x1="${padding.x}" y1="${axisY}" x2="${width-padding.x}" y2="${axisY}" stroke="rgba(255,255,255,.12)" stroke-width="1"/>
      <path d="${d}" stroke="url(#grad)" fill="none" stroke-width="2.2"/>
      ${points.map(([x,y],i)=>`<circle cx="${x}" cy="${y}" r="3" fill="#fff"/>`).join("")}
      ${points.map(([x],i)=>`<text x="${x}" y="${axisY+12}" font-size="10" text-anchor="middle" fill="rgba(255,255,255,.6)">${labels[i]}</text>`).join("")}
      <defs>
        <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#22c55e" />
          <stop offset="100%" stop-color="#3b82f6" />
        </linearGradient>
      </defs>
    </svg>
  `;
}

/* Data */
function parseRows(rows){
  const cols = {
    urun: "urun", tur: "tur", toplamYatirim: "toplamYatirim", guncelDeger: "guncelDeger",
    gunluk: "gunluk", haftalik: "haftalik", aylik: "aylik", ucAylik: "ucAylik",
    altiAylik: "altiAylik", birYillik: "birYillik",
  };
  const arr = rows.map(o => {
    const no = {};
    for (let k in cols){
      const src = o[cols[k]];
      if (k === "urun" || k === "tur") no[k] = cleanStr(src);
      else no[k] = toNumber(src);
    }
    return no;
  }).filter(item => item.urun !== "" && item.toplamYatirim > 0);
  return arr;
}

async function fetchLive(){
  const resp = await fetch(`${CSV_URL}&cachebuster=${Date.now()}`, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = (await resp.text()).trim();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false });
  const arr = parseRows(parsed.data);
  if (!arr.length) throw new Error("Veri boÅŸ");
  return arr;
}

function loadCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY_DATA);
    const when = localStorage.getItem(CACHE_KEY_TIME);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || !parsed.length) return null;
    return { data: parsed, when };
  }catch{ return null; }
}
function saveCache(data){
  try{
    localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(data));
    localStorage.setItem(CACHE_KEY_TIME, new Date().toISOString());
  }catch{}
}

async function init(){
  try{
    setStatus("Ã‡evrimiÃ§i", true);
    const live = await fetchLive();
    DATA = live;
    saveCache(DATA);
    document.getElementById("loader").style.display = "none";
    document.getElementById('last-updated').textContent = nowStr();
    renderAll();
  } catch (e){
    const cached = loadCache();
    if (cached){
      DATA = cached.data;
      document.getElementById("loader").style.display = "none";
      setAlert("CanlÄ± veri alÄ±namadÄ±, Ã¶nbellekteki son veriler gÃ¶steriliyor.");
      setStatus("Ã–nbellek", false);
      const d = new Date(cached.when || Date.now());
      document.getElementById('last-updated').textContent = d.toLocaleString('tr-TR') + " (Ã¶nbellek)";
      renderAll();
      setTimeout(init, 5000);
    } else {
      setStatus("BaÄŸlantÄ± sorunu", false);
      setAlert("Veri Ã§ekilirken bir sorun oluÅŸtu. Otomatik tekrar denenecekâ€¦");
      setTimeout(init, 2000);
    }
  }
}

/* Math helpers */
const sum = (arr, key) => arr.reduce((a, b) => a + (b[key] ?? 0), 0);
function safePeriodCard(totalCurrent, periodChange){
  const prev = totalCurrent - periodChange;
  if (!isFinite(prev) || prev === 0) return { pct: 0, prev: 0 };
  return { pct: (periodChange / prev) * 100, prev };
}
function dailyPctOf(item){
  const prev = item.guncelDeger - item.gunluk;
  return (prev && isFinite(prev)) ? (item.gunluk / prev) * 100 : 0;
}

/* Sorting */
function sortDetails(items, by, dir){
  const sgn = dir === "asc" ? 1 : -1;
  return [...items].sort((a,b) => {
    const kzA = a.guncelDeger - a.toplamYatirim;
    const kzB = b.guncelDeger - b.toplamYatirim;
    switch(by){
      case "kz": return sgn * (kzA - kzB);
      case "guncel": return sgn * (a.guncelDeger - b.guncelDeger);
      case "maliyet": return sgn * (a.toplamYatirim - b.toplamYatirim);
      case "ad": return sgn * a.urun.localeCompare(b.urun, 'tr');
      default: return 0;
    }
  });
}

/* Render */
function renderAll(){
  const dataFiltered = ACTIVE === "ALL"
    ? DATA
    : DATA.filter(x => cleanStr(x.tur).toUpperCase() === ACTIVE.toUpperCase());

  // Ã–zet panel
  const t = sum(dataFiltered, "toplamYatirim");
  const g = sum(dataFiltered, "guncelDeger");
  const kz = g - t;
  const p = (t !== 0) ? ((kz / t) * 100) : 0;

  document.getElementById("summary").innerHTML = `
    <div class="card" role="region" aria-label="Maliyet Ã¶zeti">
      <div class="small">Maliyet</div>
      <div class="big">${formatTRY(t)}</div>
    </div>
    <div class="card" role="region" aria-label="GÃ¼ncel deÄŸer Ã¶zeti">
      <div class="small">GÃ¼ncel</div>
      <div class="big">${formatTRY(g)}</div>
    </div>
    <div class="card ${kz>=0?"pos":"neg"}" role="region" aria-label="Toplam kar/zarar Ã¶zeti">
      <div class="small">Toplam K/Z</div>
      <div class="big">${formatPercentSigned(p)}</div>
      <div style="font-size:9px; font-weight:700">${sign(kz)}${formatTRY(Math.abs(kz))}</div>
    </div>`;

  // TÃ¼r KartlarÄ±
  const turlar = [...new Set(DATA.map(item => cleanStr(item.tur)))].filter(Boolean);
  let typeHtml = `
    <button class="card type-card ${ACTIVE==="ALL"?"active":""}"
            onclick="setFilter('ALL')" onkeydown="typeKeypress(event,'ALL')"
            role="tab" aria-selected="${ACTIVE==='ALL'}" aria-label="TÃ¼m varlÄ±klar" tabindex="0">
      <span class="type-color-dot" style="background:linear-gradient(135deg,#94a3b8,#334155)"></span>
      <div class="small">GENEL</div>
      <div class="big" style="font-size:11px">HEPSÄ°</div>
    </button>`;
  turlar.forEach(tur => {
    const sub = DATA.filter(x => cleanStr(x.tur) === tur);
    const subKz = sum(sub, "guncelDeger") - sum(sub, "toplamYatirim");
    const col = typeColor(tur);
    typeHtml += `
      <button class="card type-card ${ACTIVE===tur?"active":""}"
              onclick="setFilter('${tur.replace(/'/g,'\\\'')}')" onkeydown="typeKeypress(event,'${tur.replace(/'/g,'\\\'')}')"
              role="tab" aria-selected="${ACTIVE===tur}" aria-label="${tur} varlÄ±k grubu, kar/zarar ${formatTRY(subKz)}" tabindex="0">
        <span class="type-color-dot" style="background:${col}"></span>
        <div class="small">${tur.toUpperCase()}</div>
        <div class="big ${subKz>=0?'pos':'neg'}" style="font-size:11px">${sign(subKz)}${formatTRY(Math.abs(subKz))}</div>
      </button>`;
  });
  document.getElementById("types").innerHTML = typeHtml;

  // Periyotlar
  const periods = [
    ["GÃ¼nlÃ¼k","gunluk"],
    ["HaftalÄ±k","haftalik"],
    ["AylÄ±k","aylik"],
    ["3 Ay","ucAylik"],
    ["6 Ay","altiAylik"],
    ["1 YÄ±l","birYillik"],
  ];
  const totalCurrent = sum(dataFiltered, "guncelDeger");
  document.getElementById("periods").innerHTML = periods.map(([label, key]) => {
    const v = sum(dataFiltered, key);
    const { pct } = safePeriodCard(totalCurrent, v);
    const cls = v >= 0 ? "pos" : "neg";
    return `
      <div class="card ${cls}" role="region" aria-label="${label} performans">
        <div class="small">${label}</div>
        <div class="big">
          ${sign(v)}${formatTRY(Math.abs(v))}
          <span style="font-size:10px">(${formatPercentSigned(pct)})</span>
        </div>
      </div>`;
  }).join("");

  // BaÅŸlÄ±k
  document.getElementById("detail-title").innerText =
    ACTIVE === "ALL" ? "ðŸ“¦ TÃœM ÃœRÃœNLER" : `ðŸ“¦ ${ACTIVE.toUpperCase()} DETAYLARI`;

  // SÄ±ralama + Liste (click -> modal) + UyarÄ± rozet
  const sorted = sortDetails(dataFiltered, SORT_BY, SORT_DIR);
  const totalAllCurrent = sum(DATA, 'guncelDeger'); // aÄŸÄ±rlÄ±k iÃ§in gerekebilir
  const detailsHTML = sorted.map((item, i) => {
    const itemKz = item.guncelDeger - item.toplamYatirim;
    const perfSeries = [item.gunluk, item.haftalik, item.aylik, item.ucAylik, item.altiAylik, item.birYillik].map(v => Number.isFinite(v) ? v : 0);
    const alertObj = getAlertFor(item.urun);
    const dPct = dailyPctOf(item);
    const alertTriggered =
      (alertObj.guncel!=null && item.guncelDeger >= alertObj.guncel) ||
      (alertObj.kz!=null && itemKz >= alertObj.kz) ||
      (alertObj.gunlukPct!=null && dPct >= alertObj.gunlukPct);

    const alertBadge = alertTriggered
      ? `<span class="list-alert-badge" title="UyarÄ± koÅŸulu saÄŸlandÄ±" aria-label="UyarÄ± koÅŸulu saÄŸlandÄ±">âš ï¸Ž UyarÄ±</span>`
      : "";

    return `
      <div class="detail-item" role="listitem" tabindex="0" aria-label="${item.urun} detayÄ± aÃ§"
           data-idx="${i}">
        <div class="detail-info">
          <div>${item.urun} ${alertBadge} ${sparkline(perfSeries)}</div>
          <div>Maliyet: ${formatTRY(item.toplamYatirim)}</div>
        </div>
        <div class="detail-values">
          <div class="detail-val">${formatTRY(item.guncelDeger)}</div>
          <div class="detail-perc ${itemKz>=0?'pos':'neg'}">${sign(itemKz)}${formatTRY(Math.abs(itemKz))}</div>
        </div>
      </div>`;
  }).join("");
  const listEl = document.getElementById("detail-list");
  listEl.innerHTML = detailsHTML;

  // Click & Enter key -> open modal
  listEl.querySelectorAll(".detail-item").forEach(el => {
    const idx = Number(el.getAttribute('data-idx'));
    const obj = sorted[idx];
    const handler = () => openDetail(obj);
    el.addEventListener('click', handler);
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); }
    });
  });

  // Kayan Ticker
  const tickerItems = DATA.map(r => {
    const prev = r.guncelDeger - r.gunluk;
    const pct = (prev && isFinite(prev)) ? (r.gunluk / prev) * 100 : 0;
    const color = r.gunluk >= 0 ? 'var(--pos)' : 'var(--neg)';
    return `<div class="ticker-item" style="color:${color}">${r.urun} ${formatPercentSigned(pct)}</div>`;
  }).join("");
  document.getElementById("ticker-content").innerHTML = tickerItems + tickerItems + tickerItems;
}

/* Interactions */
function setFilter(t){ ACTIVE = t; renderAll(); }
function typeKeypress(e, t){
  if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); setFilter(t); }
}

function applySearch(){
  const val = document.getElementById("search").value.toLowerCase();
  const items = document.querySelectorAll(".detail-item");
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(val) ? "" : "none";
  });
}
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(applySearch, 200);
}, { passive: true });

document.getElementById('sort-by').addEventListener('change', (e) => {
  SORT_BY = e.target.value; renderAll(); applySearch();
});
document.getElementById('sort-dir').addEventListener('change', (e) => {
  SORT_DIR = e.target.value; renderAll(); applySearch();
});

/* ===== Modal: Detay KartÄ± ===== */
const modalEl = document.getElementById('modal');
const modalBody = document.getElementById('modal-body');
const modalTitle = document.getElementById('modal-title');
const modalTypeChip = document.getElementById('modal-type-chip');
const modalAlertBadge = document.getElementById('modal-alert-badge');
const modalCloseBtn = document.getElementById('modal-close-btn');

function showModal(){ modalEl.classList.add('show'); modalEl.setAttribute('aria-hidden','false'); modalCloseBtn.focus(); }
function hideModal(){ modalEl.classList.remove('show'); modalEl.setAttribute('aria-hidden','true'); }

modalCloseBtn.addEventListener('click', hideModal);
modalEl.addEventListener('click', (e) => { if (e.target === modalEl) hideModal(); });
window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalEl.classList.contains('show')) hideModal(); });

function openDetail(item){
  if (!item) return;

  // AÄŸÄ±rlÄ±klar
  const totalCurrentAll = sum(DATA, 'guncelDeger') || 1;
  const totalAylikAll = sum(DATA, 'aylik') || 0;
  const prevTotalAll = totalCurrentAll - totalAylikAll;
  const weightNow = item.guncelDeger / totalCurrentAll;
  const itemPrev = item.guncelDeger - item.aylik;
  const weightPrev = (prevTotalAll !== 0) ? (itemPrev / prevTotalAll) : 0;
  const weightDeltaPP = (weightNow - weightPrev) * 100; // yÃ¼zde puan

  // BaÅŸlÄ±k & tÃ¼r
  modalTitle.textContent = `ÃœrÃ¼n Â· ${item.urun}`;
  modalTypeChip.textContent = `TÃ¼r: ${item.tur || '-'} Â· AÄŸÄ±rlÄ±k: ${(weightNow*100).toFixed(1)}%`;

  // DeÄŸerler
  const kz = item.guncelDeger - item.toplamYatirim;

  // Trend (GÃ¼n, Hafta, Ay)
  const trendVals = [item.gunluk, item.haftalik, item.aylik].map(v => Number.isFinite(v) ? v : 0);
  const trendLabels = ["GÃ¼n", "Hafta", "Ay"];
  let activePill = "GÃ¼n";

  // UyarÄ±lar
  const alertObj = getAlertFor(item.urun);
  const dailyPct = dailyPctOf(item);
  const alertTriggered =
    (alertObj.guncel != null && item.guncelDeger >= alertObj.guncel) ||
    (alertObj.kz != null && kz >= alertObj.kz) ||
    (alertObj.gunlukPct != null && dailyPct >= alertObj.gunlukPct);
  modalAlertBadge.style.display = alertTriggered ? '' : 'none';

  // GeÃ§miÅŸ getirisi tablo verisi
  const tableData = [
    { label: "GÃ¼nlÃ¼k", key: "gunluk" },
    { label: "HaftalÄ±k", key: "haftalik" },
    { label: "AylÄ±k", key: "aylik" },
    { label: "3 Ay", key: "ucAylik" },
    { label: "6 Ay", key: "altiAylik" },
    { label: "1 YÄ±l", key: "birYillik" },
  ].map(({label, key}) => {
    const val = item[key] || 0;
    const prev = item.guncelDeger - val;
    const pct = (prev && isFinite(prev)) ? (val / prev) * 100 : 0;
    return { label, val, pct };
  });

  // Modal iÃ§eriÄŸi
  modalBody.innerHTML = `
    <div class="card" style="gap:10px">
      <div class="small">Detay</div>
      <div class="kv"><div class="key">ÃœrÃ¼n</div><div class="val">${item.urun}</div></div>
      <div class="kv"><div class="key">TÃ¼r</div><div class="val">${item.tur || '-'}</div></div>
      <div class="kv"><div class="key">AÄŸÄ±rlÄ±k</div><div class="val">${(weightNow*100).toFixed(1)}%</div></div>
    </div>

    <div class="card" style="gap:10px">
      <div class="small">DeÄŸerler</div>
      <div class="kv"><div class="key">GÃ¼ncel</div><div class="val">${formatTRY(item.guncelDeger)}</div></div>
      <div class="kv"><div class="key">Maliyet</div><div class="val">${formatTRY(item.toplamYatirim)}</div></div>
      <div class="kv"><div class="key">K/Z</div>
        <div class="val ${kz>=0?'pos':'neg'}">${sign(kz)}${formatTRY(Math.abs(kz))}</div>
      </div>
    </div>

    <div class="card" style="gap:10px">
      <div class="small">AÄŸÄ±rlÄ±k Analizi</div>
      <div class="kv"><div class="key">Mevcut</div><div class="val">${(weightNow*100).toFixed(2)}%</div></div>
      <div class="kv"><div class="key">1 Ay Ã–nce</div><div class="val">${(weightPrev*100).toFixed(2)}%</div></div>
      <div class="kv"><div class="key">DeÄŸiÅŸim</div>
        <div class="val ${weightDeltaPP>=0?'pos':'neg'}">${weightDeltaPP>=0?'+':''}${weightDeltaPP.toFixed(2)} pp</div>
      </div>
      <div class="help">Not: 1 ay Ã¶nce aÄŸÄ±rlÄ±k, aylÄ±k katkÄ± yaklaÅŸÄ±mÄ±yla hesaplanÄ±r (gÃ¼ncel âˆ’ aylÄ±k / toplam gÃ¼ncel âˆ’ toplam aylÄ±k).</div>
    </div>

    <div class="card" style="gap:10px">
      <div class="small">Trend</div>
      <div class="trend-toolbar">
        <div class="pills" role="tablist" aria-label="Trend seÃ§imi">
         map(lbl => `<button class="pill ${lbl===activePill?'active':''}" data-pill="${lbl}" role="tab" aria-selected="${lbl===activePill}">${lbl}</button>`).join('')}
        </div>
        <div class="help">SeÃ§ili Ã¶lÃ§Ã¼: <b id="trend-current-label">${activePill}</b>,
          deÄŸer: <b id="trend-current-value">${sign(trendVals[0])}${formatTRY(Math.abs(trendVals[0]))}</b></div>
      </div>
      <div class="trend-wrap" id="trend-wrap">
        ${trendLine3(trendVals, trendLabels, 420, 160)}
      </div>
    </div>

    <div class="card" style="gap:10px">
      <div class="small">GeÃ§miÅŸ Getirisi (Tablo GÃ¶rÃ¼nÃ¼mÃ¼)</div>
      <table class="table" role="table" aria-label="GeÃ§miÅŸ getirisi">
        <thead>
          <tr><th>DÃ¶nem</th><th>DeÄŸer (â‚º)</th><th>YÃ¼zde</th></tr>
        </thead>
        <tbody>
          ${tableData.map(r => `
            <tr>
              <td>${r.label}</td>
              <td class="${r.val>=0?'val-pos':'val-neg'}">${sign(r.val)}${formatTRY(Math.abs(r.val))}</td>
              <td class="${r.pct>=0?'val-pos':'val-neg'}">${formatPercentSigned(r.pct)}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>

    <div class="card" style="gap:10px">
      <div class="small">UyarÄ± TanÄ±mlarÄ±</div>
      <div class="form-grid">
        <div>
          <label class="small" for="a-guncel">GÃ¼ncel â‰¥</label>
          <input id="a-guncel" class="input" inputmode="decimal" placeholder="Ã–rn: 100000" value="${alertObj.guncel??''}">
        </div>
        <div>
          <label class="small" for="a-kz">K/Z â‰¥</label>
          <input id="a-kz" class="input" inputmode="decimal" placeholder="Ã–rn: 5000" value="${alertObj.kz??''}">
        </div>
        <div>
          <label class="small" for="a-gunlukpct">GÃ¼nlÃ¼k % â‰¥</label>
          <input id="a-gunlukpct" class="input" inputmode="decimal" placeholder="Ã–rn: 2.5" value="${alertObj.gunlukPct??''}">
        </div>
      </div>
      <div class="help">Not: SayÄ±larda virgÃ¼l veya nokta kullanabilirsiniz. Kaydedilen eÅŸikler sadece bu cihazda saklanÄ±r.</div>
      <div class="form-actions">
        <button class="btn danger" id="alerts-clear">UyarÄ±larÄ± Sil</button>
        <button class="btn primary" id="alerts-save">Kaydet</button>
      </div>
    </div>
  `;

  // Trend pill etkileÅŸimi
  const pills = modalBody.querySelectorAll('.pill');
  const labelEl = modalBody.querySelector('#trend-current-label');
  const valueEl = modalBody.querySelector('#trend-current-value');
  const wrapEl = modalBody.querySelector('#trend-wrap');

  function setActivePill(lbl){
    activePill = lbl;
    pills.forEach(p => {
      const sel = p.getAttribute('data-pill') === lbl;
      p.classList.toggle('active', sel);
      p.setAttribute('aria-selected', sel);
    });
    const idx = ["GÃ¼n","Hafta","Ay"].indexOf(lbl);
    const val = trendVals[idx] || 0;
    labelEl.textContent = lbl;
    valueEl.textContent = `${sign(val)}${formatTRY(Math.abs(val))}`;
    wrapEl.innerHTML = trendLine3(trendVals, ["GÃ¼n","Hafta","Ay"], 420, 160);
  }
  pills.forEach(p => p.addEventListener('click', () => setActivePill(p.getAttribute('data-pill'))));

  // UyarÄ±lar kaydet/sil
  const aGuncel = modalBody.querySelector('#a-guncel');
  const aKz = modalBody.querySelector('#a-kz');
  const aGunlukPct = modalBody.querySelector('#a-gunlukpct');

  modalBody.querySelector('#alerts-save').addEventListener('click', () => {
    const obj = {
      guncel: aGuncel.value ? toNumber(aGuncel.value) : null,
      kz: aKz.value ? toNumber(aKz.value) : null,
      gunlukPct: aGunlukPct.value ? toNumber(aGunlukPct.value) : null
    };
    setAlertFor(item.urun, obj);
    const dailyPctNow = dailyPctOf(item);
    const triggeredNow =
      (obj.guncel!=null && item.guncelDeger >= obj.guncel) ||
      (obj.kz!=null && kz >= obj.kz) ||
      (obj.gunlukPct!=null && dailyPctNow >= obj.gunlukPct);
    modalAlertBadge.style.display = triggeredNow ? '' : 'none';
    const old = modalCloseBtn.textContent;
    modalCloseBtn.textContent = "Kaydedildi âœ“";
    setTimeout(()=> modalCloseBtn.textContent = old, 900);
    // Liste rozetleri gÃ¼ncellensin
    renderAll(); // kÃ¼Ã§Ã¼k yeniden Ã§izim
  });

  modalBody.querySelector('#alerts-clear').addEventListener('click', () => {
    clearAlertFor(item.urun);
    aGuncel.value = ""; aKz.value = ""; aGunlukPct.value = "";
    modalAlertBadge.style.display = 'none';
    const old = modalCloseBtn.textContent;
    modalCloseBtn.textContent = "Silindi âœ“";
    setTimeout(()=> modalCloseBtn.textContent = old, 900);
    renderAll();
  });

  showModal();
}

init();
</script>
</body>
</html>
