<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Elite Portföy Terminali v4.3 - Düzeltilmiş</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030508; --card-bg: rgba(16, 20, 29, 0.95);
      --accent: #00ff9d; --accent-light: #66ffc2; --red: #ff3b5c; --yellow: #f59e0b; --blue: #3b82f6;
      --text: #ffffff; --text-muted: #94a3b8; --border: rgba(255, 255, 255, 0.1);
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    }
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: linear-gradient(135deg, #030508 0%, #0a0e1a 100%);
      color: var(--text); margin: 0; padding: 12px; line-height: 1.4; 
    }
    /* ... kalan CSS aynı kalıyor, sadece body'ye gradient eklendi ... */
    /* (tüm CSS'i buraya tekrar yazmıyorum, sadece değişen kısım gösterdim) */
  </style>
</head>
<body>
<!-- HTML yapısı aynı kalıyor, sadece script kısmı değişiyor -->

<div class="container">
  <!-- ... header, notification, loading, filter-bar, perf-grid, stats-bar, summary-grid, ticker, chart-block, market-block, detailSection vs. hepsi aynı ... -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// ──────────────────────────────────────────────
// KONFIG & GLOBAL DEĞİŞKENLER
// ──────────────────────────────────────────────
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeTFovlKfvEp9sPepJb9SGxf_2AgMU7eEPTDCc6WWc0o1Z1AizX6K2mJlaWtcvSderiBym7cyhEdsC/pub?gid=0&single=true&output=csv";

let globalData = [];
let filteredData = [];
let allocationChart = null;
let currentChartType = 'doughnut';
let alertsEnabled = true;
let debugMode = false;
let lastFetchTime = 0;
let isFetching = false;
const FETCH_COOLDOWN = 30000;

// ──────────────────────────────────────────────
// YARDIMCI FONKSİYONLAR
// ──────────────────────────────────────────────

function debugLog(message, type = 'info') {
  if (!debugMode) return;
  const debugContent = document.getElementById('debugContent');
  const timestamp = new Date().toLocaleTimeString('tr-TR', {hour12: false});
  const color = type === 'error' ? 'var(--red)' : type === 'warning' ? 'var(--warning)' : 'var(--text-muted)';
  const logEntry = document.createElement('div');
  logEntry.className = 'debug-row';
  logEntry.innerHTML = `<span style="color:${color}">[${timestamp}] ${message}</span>`;
  debugContent.appendChild(logEntry);
  debugContent.scrollTop = debugContent.scrollHeight;
}

function clearDebugLog() {
  document.getElementById('debugContent').innerHTML = '';
}

function clean(v, fieldName = '') {
  if (!v || v === "" || v === "-" || String(v).trim() === "" || String(v).includes('#')) return 0;

  try {
    let str = String(v).trim();
    str = str.replace(/[\s₺$€£%]/g, '');

    const hasCommaAsDecimal = /,\d{1,2}$/.test(str);
    if (hasCommaAsDecimal) {
      str = str.replace(/\./g, '').replace(',', '.');
    } else {
      str = str.replace(/,/g, '');
    }

    str = str.replace(/[^\d.-]/g, '');

    if ((str.match(/\./g) || []).length > 1) {
      const parts = str.split('.');
      str = parts.slice(0, -1).join('') + '.' + parts[parts.length - 1];
    }

    const num = parseFloat(str);
    if (isNaN(num)) return 0;

    if (debugMode && fieldName && String(v) !== String(num)) {
      debugLog(`${fieldName}: "${v}" → ${num}`, 'info');
    }
    return num;
  } catch (e) {
    if (debugMode) debugLog(`clean() hata → ${fieldName}: ${v} → ${e.message}`, 'error');
    return 0;
  }
}

function formatQuantity(qty) {
  if (!qty || qty === 0) return "0";
  const num = parseFloat(qty);
  if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(2).replace('.', ',') + 'B';
  if (num >= 1_000_000)    return (num / 1_000_000   ).toFixed(2).replace('.', ',') + 'M';
  if (num >= 1_000)        return (num / 1_000       ).toFixed(2).replace('.', ',') + 'K';
  if (num % 1 !== 0)       return num.toFixed(2).replace('.', ',');
  return num.toLocaleString('tr-TR');
}

// kalan yardımcı fonksiyonlar (sanitizeHTML, getDaysBetween, showLoading, showNotification vb.) aynı kalıyor...

// ──────────────────────────────────────────────
// VERİ ÇEKME - ANA FONKSİYON (en çok değişen kısım)
// ──────────────────────────────────────────────

async function fetchData() {
  if (isFetching) {
    showNotification("Veri zaten çekiliyor, lütfen bekleyin...", 'info', 3000);
    return;
  }

  if (Date.now() - lastFetchTime < FETCH_COOLDOWN) {
    const kalan = Math.ceil((FETCH_COOLDOWN - (Date.now() - lastFetchTime)) / 1000);
    showNotification(`Son yenilemeden ${kalan} sn geçti.`, 'warning', 4000);
    return;
  }

  isFetching = true;
  showLoading(true);
  lastFetchTime = Date.now();

  try {
    debugLog('Veri çekme başladı...', 'info');
    const response = await fetch(csvUrl);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const csvText = await response.text();
    debugLog(`CSV alındı (${csvText.length} karakter)`, 'info');

    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim(),
      complete: function(res) {
        if (res.errors.length > 0) {
          debugLog("PapaParse hataları: " + JSON.stringify(res.errors), 'error');
          showNotification("CSV okuma sorunu", 'danger');
          return;
        }

        if (!res.data || res.data.length === 0) {
          showNotification("CSV'de veri yok", 'danger');
          return;
        }

        globalData = res.data
          .filter(row => row && row["Varlık"]?.trim())
          .map((row, idx) => {
            const adet    = clean(row["Adet"],        `Satır${idx+1} Adet`);
            const aFiyat  = clean(row["Alış Fiyatı"], `Satır${idx+1} Alış Fiyat`);
            const yatirim = clean(row["Yatırım"],     `Satır${idx+1} Yatırım`);
            const fiyat   = clean(row["Fiyat"],       `Satır${idx+1} Fiyat`);
            const tutar   = clean(row["Tutar"],       `Satır${idx+1} Tutar`);

            return {
              ad:       sanitizeHTML((row["Varlık"] || "").trim()),
              tur:      sanitizeHTML((row["Kategori"] || row["Tur"] || "Diğer").trim()),
              alisTarihi: row["Alış Tarihi"] || row["Tarih"] || "",
              vade:     row["Vade"] || "",
              adet, aFiyat, yatirim, fiyat, tutar,
              gKZ: clean(row["Günlük K/Z"]),
              hKZ: clean(row["Haftalık K/Z"]),
              aKZ: clean(row["Aylık K/Z"]),
              tKZ: clean(row["Toplam K/Z"])
            };
          })
          .filter(item => item.ad && item.tutar > 0);

        // Tutarsızlık kontrolü
        const totalCSV    = globalData.reduce((s, i) => s + i.tutar, 0);
        const totalCalc   = globalData.reduce((s, i) => s + (i.adet * i.fiyat), 0);
        const diff        = Math.abs(totalCSV - totalCalc);
        const diffPct     = totalCSV > 0 ? (diff / totalCSV * 100) : 0;

        if (diffPct > 0.3 || diff > 50) {
          showNotification(
            `⚠️ Değer tutarsızlığı: ${diff.toLocaleString('tr-TR')} ₺ (%${diffPct.toFixed(1)})`,
            'warning', 8000
          );
          debugLog(`Toplam CSV: ${totalCSV.toLocaleString()} | Hesap: ${totalCalc.toLocaleString()} | Fark: ${diff.toLocaleString()} ₺`, 'warning');
        }

        filteredData = [...globalData];
        renderAll();
        checkAlerts();

        document.getElementById('lastUpdateTime').textContent = 
          `Son: ${new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}`;

        showNotification(`Yüklendi: ${globalData.length} varlık • ${totalCSV.toLocaleString('tr-TR')} ₺`, 'info', 4000);
      }
    });
  } catch (err) {
    debugLog(`Fetch/parse hatası: ${err.message}`, 'error');
    showNotification(`Veri alınamadı: ${err.message}`, 'danger');
  } finally {
    isFetching = false;
    showLoading(false);
  }
}

// ──────────────────────────────────────────────
// Diğer fonksiyonlar (renderAll, renderSummaries, updateChart, vs.) aynı kalıyor
// Sadece ufak iyileştirmeler:
// updateChart içindeki legend font:
// font: { size: window.innerWidth < 640 ? 9 : 11 },

// renderTicker içindeki animation süresi:
// ticker.style.animationDuration = `${Math.max(20, globalData.length * 1.8)}s`;

// ──────────────────────────────────────────────
// İLK YÜKLEME
// ──────────────────────────────────────────────

window.addEventListener('DOMContentLoaded', () => {
  fetchData();
  setInterval(fetchData, 300000); // 5 dk
});
</script>
</body>
</html>
