<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>PortfÃ¶y Terminali Pro Max</title>
<style>
:root{
  --bg:#0b1220; --card:#111827; --line:#1f2937; --pos:#22c55e; --neg:#ef4444; --accent:#3b82f6;
  --text:#e5e7eb; --muted:rgba(229,231,235,.7);
}
*{ box-sizing: border-box; }
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  overflow-x:hidden;
}
h2{ margin:14px 16px 6px; font-size:11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }

/* Ticker */
.ticker-wrap{
  width:100%; overflow:hidden; background:#1a2234; border-bottom:2px solid var(--line);
  padding:12px 0; display:flex;
}
.ticker{ display:flex; white-space:nowrap; animation: ticker-move 40s linear infinite; will-change: transform; }
.ticker-item{
  display:flex; align-items:center; padding:0 25px; font-size:16px; font-weight:800;
  border-right:1px solid rgba(255,255,255,0.1);
}
@keyframes ticker-move { 0%{ transform: translateX(0); } 100%{ transform: translateX(-50%); } }
@media (prefers-reduced-motion: reduce){
  .ticker{ animation-duration: 120s; }
}

/* Header */
.header-section{
  position: sticky; top: 0; z-index: 100;
  background: rgba(11, 18, 32, 0.95); backdrop-filter: blur(15px);
  border-bottom: 1px solid var(--line); padding: 10px 10px env(safe-area-inset-right) 10px;
}

/* Header top row */
.header-top{
  display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 0 6px 6px;
}
.badge{
  display:inline-flex; align-items:center; gap:6px; font-size:11px; color:var(--muted);
  border:1px solid var(--line); padding:4px 8px; border-radius: 999px;
}

/* Grids */
.grid-summary{ display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:12px; }
.grid-types{ display:grid; grid-template-columns: repeat(auto-fill, minmax(118px, 1fr)); gap:8px; }
.grid-periods{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; padding: 0 10px; }
@media (min-width: 560px){
  .grid-periods{ grid-template-columns: repeat(3, 1fr); }
}

/* Cards */
.card{
  background: linear-gradient(145deg, var(--card), #161e2e); border-radius: 12px; padding: 10px;
  border: 1px solid var(--line); display: flex; flex-direction: column; transition: 0.2s ease;
}
.card:focus-visible{
  outline: 3px solid var(--accent); outline-offset: 2px;
}
.big{ font-size:14px; font-weight:700; margin-top:2px; }
.small{ font-size:9px; font-weight:700; opacity:.8; text-transform: uppercase; }
.pos{ color: var(--pos); }
.neg{ color: var(--neg); }

/* Type cards */
.type-card{
  cursor: pointer; opacity: 0.9; text-align: center; border: 1px solid var(--line);
  user-select:none; position:relative; overflow:hidden;
}
.type-card:hover{ transform: translateY(-1px); }
.type-card.active{
  border-color: var(--accent); opacity:1; background: rgba(59, 130, 246, 0.12);
  box-shadow: 0 0 12px rgba(59,130,246,0.2);
}
.type-color-dot{
  position:absolute; top:8px; right:8px; width:8px; height:8px; border-radius:50%;
  box-shadow: 0 0 6px rgba(255,255,255,.2);
}

/* Detail list */
.controls{
  display:flex; gap:8px; align-items:center; padding: 0 10px; flex-wrap: wrap; margin-bottom: 8px;
}
.controls .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.select{
  background: var(--card); border:1px solid var(--line); color:var(--text);
  border-radius:8px; padding: 7px 10px; font-size:12px;
}
#search{
  width: min(420px, 100%); padding: 9px 10px; background: var(--card);
  border: 1px solid var(--line); border-radius: 8px; color: #e5e7eb;
}
.detail-item{
  background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 10px 12px;
  margin-bottom: 8px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
}
.detail-info div:first-child{ font-weight: 800; font-size: 13px; color: #fff; }
.detail-info div:last-child{ font-size: 10px; color: var(--muted); }
.detail-values{ text-align: right; }
.detail-val{ font-weight: 700; font-size: 13px; }
.detail-perc{ font-size: 11px; font-weight: 700; }

/* Sparkline */
.spark{
  width: 90px; height: 26px; display:inline-block; margin-left: 6px; opacity: .9;
}
.spark path{ fill:none; stroke-width:1.8; }

/* Loader & alerts */
#loader{
  position: fixed; inset:0; background:var(--bg); z-index:999; display:flex; flex-direction:column;
  justify-content:center; align-items:center; font-weight:bold; color:var(--accent); gap:10px;
}
.inline-alert{
  margin: 10px; padding: 8px 10px; border-radius: 8px; background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.35);
  color:#fecaca; font-size:12px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
<div id="loader" aria-live="polite">
  <div>Veriler Analiz Ediliyor...</div>
  <div style="font-size:12px; opacity:.7">LÃ¼tfen bekleyin</div>
</div>

<div class="ticker-wrap"><div class="ticker" id="ticker-content" aria-hidden="true"></div></div>

<div id="app">
  <div class="header-section">
    <div class="header-top">
      <div class="badge" id="status-badge">Durum: <span id="status-text">Ã‡evrimiÃ§i</span></div>
      <div class="badge">Son veri: <span id="last-updated">-</span></div>
    </div>

    <div class="grid-summary" id="summary" aria-label="Genel Ã¶zet"></div>
    <h2>ðŸ’¼ VarlÄ±k GruplarÄ±</h2>
    <div class="grid-types" id="types" role="tablist" aria-label="VarlÄ±k tÃ¼rleri"></div>
  </div>

  <div class="content-section" style="padding: 0 10px;">
    <h2>ðŸ“ˆ DÃ¶nemsel Performans</h2>
    <div id="periods" class="grid-periods" role="region" aria-label="DÃ¶nemsel performans kartlarÄ±"></div>

    <h2 id="detail-title">ðŸ“¦ ÃœrÃ¼n DetaylarÄ±</h2>

    <div class="controls">
      <div class="row" role="group" aria-label="SÄ±ralama">
        <label class="small" for="sort-by" style="opacity:.8">SÄ±rala:</label>
        <select id="sort-by" class="select" aria-label="SÄ±ralama Ã¶lÃ§Ã¼tÃ¼">
          <option value="kz">K/Z</option>
          <option value="guncel">GÃ¼ncel</option>
          <option value="maliyet">Maliyet</option>
          <option value="ad">Ad</option>
        </select>
        <select id="sort-dir" class="select" aria-label="SÄ±ralama yÃ¶nÃ¼">
          <option value="desc">Azalan</option>
          <option value="asc">Artan</option>
        </select>
      </div>
      <div class="row" style="margin-left:auto">
        <input type="text" id="search" placeholder="ÃœrÃ¼n ara..." aria-label="ÃœrÃ¼n ara" />
      </div>
    </div>

    <div id="detail-list" role="list" aria-label="ÃœrÃ¼n listesi"></div>

    <div id="inline-alert" class="inline-alert" style="display:none"></div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLPFVZn0j8Ygu914QDGRCGKsVy88gWjdk7DFi-jWiydmqYsdGUE4hEAb-R_IBzQmtFZwoMJFcN6rlD/pub?gid=1050165900&single=true&output=csv";

// Cache
const CACHE_KEY_DATA = "portfolio_cache_data_v1";
const CACHE_KEY_TIME = "portfolio_cache_time_v1";

let DATA = [];
let ACTIVE = "ALL";
let searchDebounceTimer = null;
let SORT_BY = "kz";   // kz | guncel | maliyet | ad
let SORT_DIR = "desc";// desc | asc

/* Utils */
const cleanStr = (s) => s ? s.toString().trim().replace(/\s+/g, ' ') : "";
function toNumber(v){
  if (v === null || v === undefined) return 0;
  let str = v.toString().trim()
    .replace(/[^\d,\.\-]/g, '')              // para simge/boÅŸluk temizle, iÅŸaretleri koru
    .replace(/\.(?=\d{3}(\D|$))/g, '')       // binlik noktalarÄ±nÄ± kaldÄ±r
    .replace(',', '.');                      // ondalÄ±k virgÃ¼l -> nokta
  const num = parseFloat(str);
  if (!Number.isFinite(num)) return 0;
  return Math.abs(num) === 0 ? 0 : num;      // -0 -> 0
}
const formatTRY = v => (isFinite(v) ? Math.round(v) : 0).toLocaleString('tr-TR') + " â‚º";
const sign = v => (v >= 0 ? '+' : '');
const formatPercentSigned = v => `${v >= 0 ? '+' : ''}${Math.abs(v).toFixed(1)}%`;
const nowStr = () => new Date().toLocaleString('tr-TR');

/* Type color (deterministic hash -> palette) */
const TYPE_PALETTE = [
  "#22c55e","#3b82f6","#a78bfa","#f59e0b","#ef4444","#06b6d4","#10b981","#f472b6","#f97316","#84cc16"
];
function typeColor(tur){
  const s = cleanStr(tur).toUpperCase();
  let h = 0; for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) & 0xffffffff;
  const idx = Math.abs(h) % TYPE_PALETTE.length;
  return TYPE_PALETTE[idx];
}

/* DOM helpers */
function setAlert(msg){
  const el = document.getElementById('inline-alert');
  if (!msg) { el.style.display='none'; el.textContent=''; return; }
  el.textContent = msg;
  el.style.display = '';
}
function setStatus(text, online=true){
  document.getElementById('status-text').textContent = text;
  document.getElementById('status-badge').style.borderColor = online ? "rgba(34,197,94,.5)" : "rgba(239,68,68,.5)";
}

/* Sparkline (small inline SVG) */
function sparkline(values, width=90, height=26, color="#22c55e"){
  // values: sayÄ±sal dizi, eksikler 0
  const vals = values.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...vals, 0);
  const max = Math.max(...vals, 0);
  const span = (max - min) || 1;
  const step = (width - 6) / Math.max(vals.length - 1, 1); // 3px padding solda/saÄŸda
  let d = "";
  vals.forEach((v, i) => {
    const x = 3 + i * step;
    const y = height - 3 - ((v - min) / span) * (height - 6); // 3px top/bottom padding
    d += (i === 0 ? `M${x},${y}` : ` L${x},${y}`);
  });
  const last = vals[vals.length - 1] || 0;
  const stroke = last >= 0 ? "var(--pos)" : "var(--neg)";
  return `
    <svg class="spark" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" aria-hidden="true">
      <path d="${d}" stroke="${stroke}"></path>
      <line x1="0" y1="${height-3}" x2="${width}" y2="${height-3}" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
    </svg>
  `;
}

/* Data */
function parseRows(rows){
  // Beklenen kolon isimleri (Google Sheetâ€™te birebir isimler)
  const cols = {
    urun: "urun", tur: "tur", toplamYatirim: "toplamYatirim", guncelDeger: "guncelDeger",
    gunluk: "gunluk", haftalik: "haftalik", aylik: "aylik", ucAylik: "ucAylik",
    altiAylik: "altiAylik", birYillik: "birYillik",
  };
  const arr = rows.map(o => {
    const no = {};
    for (let k in cols){
      const src = o[cols[k]];
      if (k === "urun" || k === "tur") no[k] = cleanStr(src);
      else no[k] = toNumber(src);
    }
    return no;
  }).filter(item => item.urun !== "" && item.toplamYatirim > 0);
  return arr;
}

async function fetchLive(){
  const resp = await fetch(`${CSV_URL}&cachebuster=${Date.now()}`, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = (await resp.text()).trim();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false });
  const arr = parseRows(parsed.data);
  if (!arr.length) throw new Error("Veri boÅŸ");
  return arr;
}

function loadCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY_DATA);
    const when = localStorage.getItem(CACHE_KEY_TIME);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || !parsed.length) return null;
    return { data: parsed, when };
  }catch{ return null; }
}
function saveCache(data){
  try{
    localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(data));
    localStorage.setItem(CACHE_KEY_TIME, new Date().toISOString());
  }catch{}
}

async function init(){
  try{
    setStatus("Ã‡evrimiÃ§i", true);
    const live = await fetchLive();
    DATA = live;
    saveCache(DATA);
    document.getElementById("loader").style.display = "none";
    document.getElementById('last-updated').textContent = nowStr();
    renderAll();
  } catch (e){
    const cached = loadCache();
    if (cached){
      DATA = cached.data;
      document.getElementById("loader").style.display = "none";
      setAlert("CanlÄ± veri alÄ±namadÄ±, Ã¶nbellekteki son veriler gÃ¶steriliyor.");
      setStatus("Ã–nbellek", false);
      const d = new Date(cached.when || Date.now());
      document.getElementById('last-updated').textContent = d.toLocaleString('tr-TR') + " (Ã¶nbellek)";
      renderAll();
      // Yeniden dene (sessiz) â€” kullanÄ±cÄ±yÄ± rahatsÄ±z etmeden
      setTimeout(init, 5000);
    } else {
      setStatus("BaÄŸlantÄ± sorunu", false);
      setAlert("Veri Ã§ekilirken bir sorun oluÅŸtu. Otomatik tekrar denenecekâ€¦");
      setTimeout(init, 2000);
    }
  }
}

/* Math helpers */
const sum = (arr, key) => arr.reduce((a, b) => a + (b[key] ?? 0), 0);
function safePeriodCard(totalCurrent, periodChange){
  const prev = totalCurrent - periodChange;
  if (!isFinite(prev) || prev === 0) return { pct: 0, prev: 0 };
  return { pct: (periodChange / prev) * 100, prev };
}

/* Sorting */
function sortDetails(items, by, dir){
  const sgn = dir === "asc" ? 1 : -1;
  return [...items].sort((a,b) => {
    const kzA = a.guncelDeger - a.toplamYatirim;
    const kzB = b.guncelDeger - b.toplamYatirim;
    switch(by){
      case "kz": return sgn * (kzA - kzB);
      case "guncel": return sgn * (a.guncelDeger - b.guncelDeger);
      case "maliyet": return sgn * (a.toplamYatirim - b.toplamYatirim);
      case "ad": return sgn * a.urun.localeCompare(b.urun, 'tr');
      default: return 0;
    }
  });
}

/* Render */
function renderAll(){
  const dataFiltered = ACTIVE === "ALL"
    ? DATA
    : DATA.filter(x => cleanStr(x.tur).toUpperCase() === ACTIVE.toUpperCase());

  // Ã–zet panel
  const t = sum(dataFiltered, "toplamYatirim");
  const g = sum(dataFiltered, "guncelDeger");
  const kz = g - t;
  const p = (t !== 0) ? ((kz / t) * 100) : 0;

  document.getElementById("summary").innerHTML = `
    <div class="card" role="region" aria-label="Maliyet Ã¶zeti">
      <div class="small">Maliyet</div>
      <div class="big">${formatTRY(t)}</div>
    </div>
    <div class="card" role="region" aria-label="GÃ¼ncel deÄŸer Ã¶zeti">
      <div class="small">GÃ¼ncel</div>
      <div class="big">${formatTRY(g)}</div>
    </div>
    <div class="card ${kz>=0?"pos":"neg"}" role="region" aria-label="Toplam kar/zarar Ã¶zeti">
      <div class="small">Toplam K/Z</div>
      <div class="big">${formatPercentSigned(p)}</div>
      <div style="font-size:9px; font-weight:700">${sign(kz)}${formatTRY(Math.abs(kz))}</div>
    </div>`;

  // TÃ¼r KartlarÄ±
  const turlar = [...new Set(DATA.map(item => cleanStr(item.tur)))].filter(Boolean);
  let typeHtml = `
    <button class="card type-card ${ACTIVE==="ALL"?"active":""}"
            onclick="setFilter('ALL')" onkeydown="typeKeypress(event,'ALL')"
            role="tab" aria-selected="${ACTIVE==='ALL'}" aria-label="TÃ¼m varlÄ±klar" tabindex="0">
      <span class="type-color-dot" style="background:linear-gradient(135deg,#94a3b8,#334155)"></span>
      <div class="small">GENEL</div>
      <div class="big" style="font-size:11px">HEPSÄ°</div>
    </button>`;
  turlar.forEach(tur => {
    const sub = DATA.filter(x => cleanStr(x.tur) === tur);
    const subKz = sum(sub, "guncelDeger") - sum(sub, "toplamYatirim");
    const col = typeColor(tur);
    typeHtml += `
      <button class="card type-card ${ACTIVE===tur?"active":""}"
              onclick="setFilter('${tur.replace(/'/g,'\\\'')}')" onkeydown="typeKeypress(event,'${tur.replace(/'/g,'\\\'')}')"
              role="tab" aria-selected="${ACTIVE===tur}" aria-label="${tur} varlÄ±k grubu, kar/zarar ${formatTRY(subKz)}" tabindex="0">
        <span class="type-color-dot" style="background:${col}"></span>
        <div class="small">${tur.toUpperCase()}</div>
        <div class="big ${subKz>=0?'pos':'neg'}" style="font-size:11px">${sign(subKz)}${formatTRY(Math.abs(subKz))}</div>
      </button>`;
  });
  document.getElementById("types").innerHTML = typeHtml;

  // Periyotlar
  const periods = [
    ["GÃ¼nlÃ¼k","gunluk"],
    ["HaftalÄ±k","haftalik"],
    ["AylÄ±k","aylik"],
    ["3 Ay","ucAylik"],
    ["6 Ay","altiAylik"],
    ["1 YÄ±l","birYillik"],
  ];
  const totalCurrent = sum(dataFiltered, "guncelDeger");
  document.getElementById("periods").innerHTML = periods.map(([label, key]) => {
    const v = sum(dataFiltered, key);
    const { pct } = safePeriodCard(totalCurrent, v);
    const cls = v >= 0 ? "pos" : "neg";
    return `
      <div class="card ${cls}" role="region" aria-label="${label} performans">
        <div class="small">${label}</div>
        <div class="big">
          ${sign(v)}${formatTRY(Math.abs(v))}
          <span style="font-size:10px">(${formatPercentSigned(pct)})</span>
        </div>
      </div>`;
  }).join("");

  // BaÅŸlÄ±k
  document.getElementById("detail-title").innerText =
    ACTIVE === "ALL" ? "ðŸ“¦ TÃœM ÃœRÃœNLER" : `ðŸ“¦ ${ACTIVE.toUpperCase()} DETAYLARI`;

  // SÄ±ralama + Liste
  const sorted = sortDetails(dataFiltered, SORT_BY, SORT_DIR);
  const detailsHTML = sorted.map(item => {
    const itemKz = item.guncelDeger - item.toplamYatirim;
    const perfSeries = [
      item.gunluk, item.haftalik, item.aylik, item.ucAylik, item.altiAylik, item.birYillik
    ].map(v => Number.isFinite(v) ? v : 0);

    return `
      <div class="detail-item" role="listitem">
        <div class="detail-info">
          <div>${item.urun} ${sparkline(perfSeries)}</div>
          <div>Maliyet: ${formatTRY(item.toplamYatirim)}</div>
        </div>
        <div class="detail-values">
          <div class="detail-val">${formatTRY(item.guncelDeger)}</div>
          <div class="detail-perc ${itemKz>=0?'pos':'neg'}">${sign(itemKz)}${formatTRY(Math.abs(itemKz))}</div>
        </div>
      </div>`;
  }).join("");
  document.getElementById("detail-list").innerHTML = detailsHTML;

  // Kayan Ticker (gÃ¼nlÃ¼k deÄŸiÅŸim yÃ¼zdesi â€” gÃ¼n baÅŸÄ±na gÃ¶re)
  const tickerItems = DATA.map(r => {
    const prev = r.guncelDeger - r.gunluk;
    const pct = (prev && isFinite(prev)) ? (r.gunluk / prev) * 100 : 0;
    const color = r.gunluk >= 0 ? 'var(--pos)' : 'var(--neg)';
    return `<div class="ticker-item" style="color:${color}">${r.urun} ${formatPercentSigned(pct)}</div>`;
  }).join("");
  document.getElementById("ticker-content").innerHTML = tickerItems + tickerItems + tickerItems;
}

/* Interactions */
function setFilter(t){ ACTIVE = t; renderAll(); }
function typeKeypress(e, t){
  if (e.key === 'Enter' || e.key === ' '){
    e.preventDefault(); setFilter(t);
  }
}

function applySearch(){
  const val = document.getElementById("search").value.toLowerCase();
  const items = document.querySelectorAll(".detail-item");
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(val) ? "" : "none";
  });
}
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(applySearch, 200);
}, { passive: true });

document.getElementById('sort-by').addEventListener('change', (e) => {
  SORT_BY = e.target.value; renderAll(); applySearch();
});
document.getElementById('sort-dir').addEventListener('change', (e) => {
  SORT_DIR = e.target.value; renderAll(); applySearch();
});

init();
</script>
</body>
</html>
